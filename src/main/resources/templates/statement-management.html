<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <title th:text="${appName} + ' - Statement Management'">EverRich - Statement Management</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" th:href="@{/css/app-theme.css}">
    <style>
        /* Specific tweaks for Statement Page */
        #loading-spinner { 
            display: none; 
            margin-top: 1rem; 
            color: var(--accent-color); 
            font-weight: 600; 
            font-size: 0.9rem;
        }
        
        /* Status Color Coding */
        .status-COMPLETED { color: var(--success-color); font-weight: 600; } 
        .status-FAILED { color: var(--error-color); font-weight: 600; } 
        .status-PROCESSING { color: #F59E0B; font-weight: 600; } 

        .upload-controls {
            display: flex;
            gap: 1rem;
            align-items: center;
            flex-wrap: wrap;
        }
        
        /* Consistent styling for form inputs */
        .upload-controls select,
        .upload-controls input[type="file"] {
            padding: 0.75rem;
            font-size: 0.95rem;
            border: 1px solid #D1D5DB;
            border-radius: 0.25rem;
            font-family: inherit;
        }
        
        .upload-controls select:focus,
        .upload-controls input[type="file"]:focus {
            outline: none;
            border-color: var(--accent-color);
            box-shadow: 0 0 0 3px rgba(4, 120, 87, 0.1);
        }

        @media (max-width: 767px) {
            .upload-controls { flex-direction: column; align-items: stretch; }
            .title-full { display: none; }
            .title-short { display: inline; }
            
            /* Restrict filename length to 30 characters in mobile list */
            .mobile-card-title {
                display: inline-block;
                max-width: 30ch; /* 30 characters */
                overflow: hidden;
                text-overflow: ellipsis;
                white-space: nowrap;
            }
            
            /* Consistent styling for form inputs in mobile mode */
            .upload-controls select,
            .upload-controls input[type="file"] {
                padding: 0.5rem;
                font-size: 0.9rem;
                border: 1px solid #D1D5DB;
                border-radius: 0.25rem;
                width: 100%;
                max-width: 100%;
            }
            
            .upload-controls select:focus,
            .upload-controls input[type="file"]:focus {
                outline: none;
                border-color: var(--accent-color);
                box-shadow: 0 0 0 3px rgba(4, 120, 87, 0.1);
            }
            
            .upload-controls button {
                padding: 0.5rem 1rem;
                font-size: 0.95rem;
                width: 100%;
            }
        }
        
        @media (min-width: 768px) {
            .title-short { display: none; }
        }
    </style>
</head>
<body>
    <div th:replace="~{fragments/header :: appHeader}"></div>
    
    <div class="content-container">
        
        <div class="page-header">
            <a href="/" class="back-link">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 12H5"></path><path d="M12 19l-7-7 7-7"></path></svg>
                Back
            </a>
            <h2>
                <span class="title-full">Statement Management</span>
                <span class="title-short">Statements</span>
            </h2>
        </div>

        <div class="content-wrapper">
            <h3 style="margin-top: 0; margin-bottom: 1rem;">Upload New Statement (PDF)</h3>
            
            <div id="message-container"></div>
            
            <form id="uploadForm">
                <div class="upload-controls">
                    <select id="accountSelect" name="accountId" required style="flex: 1;">
                        <option value="">-- Select an Account --</option>
                        <option th:each="account : ${accounts}" th:value="${account.id}" th:text="${account.name}"></option>
                    </select>
                    
                    <input type="file" id="fileInput" name="file" accept="application/pdf" required style="flex: 2;">

                    <button type="submit" id="uploadButton" class="btn-primary" disabled title="Please select an account and a file.">
                        Upload and Start Processing
                    </button>
                </div>
            </form>
            
            <div id="loading-spinner">
                <svg class="animate-spin" style="display:inline; margin-right: 5px; vertical-align: middle;" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 12a9 9 0 1 1-6.219-8.56"/></svg>
                Processing your file... Please wait or navigate to the list below.
            </div>
        </div>

        <div id="statement-list-section">
            <div class="data-table-wrapper">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Uploaded Statements</th> 
                        </tr>
                    </thead>
                    <tbody>
                        <tr th:each="stmt : ${statements}"
                            th:data-status-name="${stmt.status.name()}"
                            th:data-href="${stmt.status.name() == 'COMPLETED' ? '/statements/' + stmt.id : ''}">
                            <td>
                                <strong>
                                    <span th:text="${stmt.id}">ID</span> - <span th:text="${stmt.originalFileName}">File.pdf</span>
                                </strong><br/>
                                <span style="font-size: 0.8em; color: var(--text-mellow);">Account - <span th:text="${stmt.account != null ? stmt.account.name : 'N/A'}">Account</span></span><br/>
                                <span style="font-size: 0.8em; color: var(--text-mellow);">Uploaded - <span th:text="${#temporals.format(stmt.uploadDateTime, 'dd MMM yyyy HH:mm')}">Date</span></span><br/>
                                
                                <span style="font-size: 0.9em; display: inline-block; margin-top: 0.25rem;"
                                      th:text="${stmt.status}"
                                      th:classappend="'status-' + ${stmt.status.name()}">STATUS</span>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <div class="mobile-list">
                <div th:each="stmt : ${statements}" 
                     class="mobile-card"
                     th:data-status-name="${stmt.status.name()}"
                     th:data-href="${stmt.status.name() == 'COMPLETED' ? '/statements/' + stmt.id : ''}"
                     th:classappend="${stmt.status.name() == 'COMPLETED' ? 'clickable' : ''}">
                    
                    <div class="mobile-card-header">
                        <span class="mobile-card-title" th:text="${stmt.originalFileName}">File.pdf</span>
                        <span style="font-size: 0.85rem;" 
                              th:text="${stmt.status}" 
                              th:classappend="'status-' + ${stmt.status.name()}">STATUS</span>
                    </div>
                    
                    <div class="mobile-card-description">
                        <div style="margin-bottom: 4px;">
                            <strong>ID:</strong> <span th:text="${stmt.id}">ID</span>
                        </div>
                        <div style="margin-bottom: 4px;">
                            <strong>Account:</strong> <span th:text="${stmt.account != null ? stmt.account.name : 'N/A'}">Account</span>
                        </div>
                        <div>
                            <strong>Uploaded:</strong> <span th:text="${#temporals.format(stmt.uploadDateTime, 'dd MMM yyyy HH:mm')}">Date</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const uploadForm = document.getElementById('uploadForm');
            const fileInput = document.getElementById('fileInput');
            const accountSelect = document.getElementById('accountSelect');
            const uploadButton = document.getElementById('uploadButton');
            const spinner = document.getElementById('loading-spinner');
            const messageContainer = document.getElementById('message-container');

            function updateUploadButtonState() {
                const isAccountSelected = accountSelect.value !== '';
                const isFileSelected = fileInput.files.length > 0;
                uploadButton.disabled = !(isAccountSelected && isFileSelected);
            }

            accountSelect.addEventListener('change', updateUploadButtonState);
            fileInput.addEventListener('change', updateUploadButtonState);

            uploadForm.addEventListener('submit', function (event) {
                event.preventDefault();
                messageContainer.innerHTML = '';
                spinner.style.display = 'block';
                uploadButton.disabled = true;

                const formData = new FormData();
                formData.append('file', fileInput.files[0]);
                formData.append('accountId', accountSelect.value);

                fetch('/api/statement/upload', {
                    method: 'POST',
                    body: formData,
                })
                .then(response => response.json().then(data => ({ status: response.status, body: data })))
                .then(result => {
                    spinner.style.display = 'none';
                    updateUploadButtonState();

                    if (result.status >= 200 && result.status < 300) {
                        messageContainer.innerHTML = `<div class="alert alert-success">${result.body.message} Refreshing list...</div>`;
                        // Reload to update the list and ensure it's visible
                        setTimeout(() => window.location.reload(), 2000);
                    } else {
                        messageContainer.innerHTML = `<div class="alert alert-error">Upload Error: ${result.body.message || 'An unknown error occurred.'}</div>`;
                    }
                })
                .catch(error => {
                    spinner.style.display = 'none';
                    updateUploadButtonState();
                    messageContainer.innerHTML = `<div class="alert alert-error">A network error prevented the upload.</div>`;
                });
            });

            // Handle click events for both Table Rows and Mobile Cards
            const attachClickEvents = () => {
                const targets = document.querySelectorAll('.data-table tbody tr, .mobile-card');
                targets.forEach((el) => {
                    if (el.dataset.statusName === 'COMPLETED') {
                        el.classList.add('clickable');
                        el.addEventListener('click', function () {
                            const href = this.dataset.href;
                            if (href) window.location.href = href;
                        });
                    }
                });
            };

            attachClickEvents();
        });
    </script>
</body>
</html>