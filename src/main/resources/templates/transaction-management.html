<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">

<head>
    <title th:text="${appName} + ' - Transaction Management'">EverRich - Transaction Management</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" th:href="@{/css/app-theme.css}">
    <style>
        /* Page-specific styles for Transaction Management */
        
        /* Mobile responsive title override */
        @media (max-width: 767px) {
            .page-header h2::after {
                content: "Transactions";
            }

            .page-header h2 {
                font-size: 0;
            }

            .page-header h2::after {
                font-size: 1.25rem;
            }
        }
    </style>
</head>

<body>
    <div th:replace="fragments/header :: appHeader"></div>

    <div id="toast-container"></div>
    
    <div id="confirmation-modal" class="modal">
        <div class="modal-content">
            <p id="modal-message"></p>
            <div class="modal-buttons">
                <button id="modal-confirm-btn">Yes, I'm Sure</button>
                <button id="modal-cancel-btn">Cancel</button>
            </div>
        </div>
    </div>

    <div class="content-container-full">
        <div class="page-header">
            <a href="/" class="back-link">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
                    stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M19 12H5"></path>
                    <path d="M12 19l-7-7 7-7"></path>
                </svg>
                Back
            </a>
            <h2>Review Transaction</h2>
        </div>

        <div class="content-wrapper">
            <form id="filter-form" action="/transactions" method="get">
                <input type="checkbox" id="filter-toggle" name="filter-toggle-state" 
                    th:checked="${selectedTimeframe != 'current_month' or selectedCategoryIds != null or selectedQuery != null}">

                <div class="filter-summary">
                    <label for="filter-toggle" class="filter-toggle-label">
                        Applied Filters
                        <svg class="toggle-icon" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" 
                             stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <polyline points="6 9 12 15 18 9"></polyline>
                        </svg>
                    </label>
                    <div class="summary-content" id="filter-summary-content"></div>
                </div>

                <div class="filter-controls">
                    <div class="filter-grid">
                        <!-- Timeframe -->
                        <div class="filter-field">
                            <label for="timeframe">Timeframe</label>
                            <select id="timeframe" name="timeframe">
                                <option value="current_month" th:selected="${selectedTimeframe == 'current_month'}">This Month</option>
                                <option value="last_month" th:selected="${selectedTimeframe == 'last_month'}">Previous Month</option>
                                <option value="current_year" th:selected="${selectedTimeframe == 'current_year'}">This Year</option>
                                <option value="previous_year" th:selected="${selectedTimeframe == 'previous_year'}">Previous Year</option>
                                <option value="entire_timeframe" th:selected="${selectedTimeframe == 'entire_timeframe'}">Entire Timeframe</option>
                                <option value="date_range" th:selected="${selectedTimeframe == 'date_range'}">Date Range</option>
                            </select>
                            <div id="date-range-fields" class="date-inputs">
                                <input type="date" id="start-date" name="startDate" placeholder="From Date"
                                    th:value="${selectedStartDate != null ? selectedStartDate : ''}" 
                                    onfocus="(this.type='date')" onblur="if(!this.value)this.type='text'">
                                <input type="date" id="end-date" name="endDate" placeholder="To Date"
                                    th:value="${selectedEndDate != null ? selectedEndDate : ''}"
                                    onfocus="(this.type='date')" onblur="if(!this.value)this.type='text'">
                            </div>
                        </div>

                        <!-- Account -->
                        <div class="filter-field category-group">
                            <label for="account-display">Account</label>
                            <div style="display: flex; align-items: center;">
                                <input type="text" id="account-display" placeholder="Select accounts" readonly style="cursor: pointer; flex: 1;" value="Selected: " />
                                <span id="account-selected-count" style="margin-left: -50px; font-size: 0.85rem; color: var(--accent-color); font-weight: bold; z-index: 5; min-width: 40px; text-align: left;">All</span>
                            </div>
                            <div id="account-list-dropdown" style="display:none;">
                                <div class="category-toggle-container">
                                    <div>
                                        <input type="checkbox" id="select-all-accounts">
                                        <label for="select-all-accounts">Select All</label>
                                    </div>
                                    <div>
                                        <input type="checkbox" id="clear-all-accounts">
                                        <label for="clear-all-accounts">Clear All</label>
                                    </div>
                                </div>
                                <div th:each="account : ${accounts}">
                                    <input type="checkbox" th:id="${'acc-' + account.id}" name="accountIds"
                                        th:value="${account.id}" class="account-checkbox"
                                        th:checked="${selectedAccountIds != null and #lists.contains(selectedAccountIds, account.id)}">
                                    <label th:for="${'acc-' + account.id}" th:text="${account.id + ' - ' + account.name}">Account Name</label>
                                </div>
                            </div>
                        </div>

                        <!-- Categories -->
                        <div class="filter-field category-group">
                            <label for="category-display">Categories</label>
                            <div style="display: flex; align-items: center;">
                                <input type="text" id="category-display" placeholder="Select categories" readonly style="cursor: pointer; flex: 1;" value="Selected: " />
                                <span id="selected-count" style="margin-left: -50px; font-size: 0.85rem; color: var(--accent-color); font-weight: bold; z-index: 5; min-width: 40px; text-align: left;">All</span>
                            </div>
                            <div id="category-list-dropdown" style="display:none;">
                                <div class="category-toggle-container">
                                    <div>
                                        <input type="checkbox" id="select-all-categories">
                                        <label for="select-all-categories">Select All</label>
                                    </div>
                                    <div>
                                        <input type="checkbox" id="clear-all-categories">
                                        <label for="clear-all-categories">Clear All</label>
                                    </div>
                                </div>
                                <div th:each="category : ${categories}">
                                    <input type="checkbox" th:id="${'cat-' + category.id}" name="categoryIds"
                                        th:value="${category.id}" class="category-checkbox"
                                        th:checked="${selectedCategoryIds != null and #lists.contains(selectedCategoryIds, category.id)}">
                                    <label th:for="${'cat-' + category.id}" th:text="${category.name}">Category Name</label>
                                </div>
                            </div>
                        </div>

                        <!-- Search -->
                        <div class="filter-field">
                            <label for="full-text-query">Search (Description, Category)</label>
                            <input type="text" id="full-text-query" name="query" placeholder="Enter keywords..."
                                th:value="${selectedQuery != null ? selectedQuery : ''}" />
                        </div>
                    </div>

                    <button type="submit" id="apply-filters-btn" class="btn-filter">Apply Filters</button>
                </div>
            </form>
        </div>

        <h3 th:text="${#lists.size(transactions)} + ' transaction(s) found'">0 transaction(s) found</h3>
        
        <!-- Desktop Table -->
        <table class="data-table">
            <thead>
                <tr>
                    <th>Date</th>
                    <th>Account</th>
                    <th>Description</th>
                    <th>Amount</th>
                    <th>Category</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                <tr th:each="transaction : ${transactions}">
                    <td th:text="${#temporals.format(transaction.date, 'dd MMM yyyy')}">01 Jan 2025</td>
                    <td th:text="${transaction.account != null ? transaction.account.id + ' - ' + transaction.account.name : 'N/A'}">Account Info</td>
                    <td th:text="${transaction.description}">Netflix Subscription</td>
                    <td th:classappend="${transaction.operation != null and transaction.operation.name() == 'MINUS' ? 'amount-negative' : 'amount-positive'}">
                        <span th:text="${#numbers.formatDecimal(transaction.amount, 1, 'COMMA', 2, 'POINT')}">5.99</span> €
                    </td>
                    <td th:text="${transaction.categoryEntity?.name ?: 'Uncategorized'}">Uncategorized</td>
                    <td>
                        <div class="action-buttons-container">
                            <a th:href="@{/transactions/edit/{id}(id=${transaction.id}, timeframe=${selectedTimeframe}, startDate=${selectedStartDate}, endDate=${selectedEndDate}, accountIds=${selectedAccountIds}, categoryIds=${selectedCategoryIds}, query=${selectedQuery})}" class="btn-edit">Edit</a>
                            <form th:action="@{/transactions/{id}/delete(id=${transaction.id})}" method="post" style="display:inline;">
                                <input type="hidden" name="timeframe" th:if="${selectedTimeframe != null}" th:value="${selectedTimeframe}" />
                                <input type="hidden" name="startDate" th:if="${selectedStartDate != null}" th:value="${selectedStartDate}" />
                                <input type="hidden" name="endDate" th:if="${selectedEndDate != null}" th:value="${selectedEndDate}" />
                                <div th:if="${selectedAccountIds != null}" th:each="accId : ${selectedAccountIds}">
                                    <input type="hidden" name="accountIds" th:value="${accId}" />
                                </div>
                                <input type="hidden" name="query" th:if="${selectedQuery != null}" th:value="${selectedQuery}" />
                                <div th:if="${selectedCategoryIds != null}" th:each="catId : ${selectedCategoryIds}">
                                    <input type="hidden" name="categoryIds" th:value="${catId}" />
                                </div>
                                <button type="button" class="btn-delete" th:attr="data-transaction-id=${transaction.id}">Delete</button>
                            </form>
                        </div>
                    </td>
                </tr>
                <tr th:if="${transactions.empty}">
                    <td colspan="6" style="text-align: center; padding: 2rem;">No transactions match the current filter criteria.</td>
                </tr>
            </tbody>
        </table>

        <!-- Mobile Cards -->
        <div class="transaction-list-mobile">
            <div th:each="transaction : ${transactions}" class="transaction-card">
                <div class="card-header">
                    <div class="card-date-account">
                        <span th:text="${#temporals.format(transaction.date, 'dd MMM yyyy')}">01 Jan 2025</span> |
                        <span th:text="${transaction.account != null ? transaction.account.name : 'N/A'}">Account Name</span>
                    </div>
                    <div th:classappend="${transaction.operation != null and transaction.operation.name() == 'MINUS' ? 'amount-negative' : 'amount-positive'}" class="card-amount">
                        <span th:text="${#numbers.formatDecimal(transaction.amount, 1, 'COMMA', 2, 'POINT')}">5.99</span> €
                    </div>
                </div>
                
                <div class="card-description" th:text="${transaction.description}">Netflix Subscription</div>
                
                <div class="card-details">
                    <div class="detail-item">
                        <strong>Category</strong>
                        <span th:text="${transaction.categoryEntity?.name ?: 'Uncategorized'}">Category Name</span>
                    </div>
                    
                    <div class="card-actions-inline">
                        <a th:href="@{/transactions/edit/{id}(id=${transaction.id}, timeframe=${selectedTimeframe}, startDate=${selectedStartDate}, endDate=${selectedEndDate}, accountIds=${selectedAccountIds}, categoryIds=${selectedCategoryIds}, query=${selectedQuery})}" 
                           class="btn-icon-edit" title="Edit">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                                <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                            </svg>
                        </a>
                        <form th:action="@{/transactions/{id}/delete(id=${transaction.id})}" method="post" style="display: inline;">
                            <input type="hidden" name="timeframe" th:if="${selectedTimeframe != null}" th:value="${selectedTimeframe}" />
                            <input type="hidden" name="startDate" th:if="${selectedStartDate != null}" th:value="${selectedStartDate}" />
                            <input type="hidden" name="endDate" th:if="${selectedEndDate != null}" th:value="${selectedEndDate}" />
                            <div th:if="${selectedAccountIds != null}" th:each="accId : ${selectedAccountIds}">
                                <input type="hidden" name="accountIds" th:value="${accId}" />
                            </div>
                            <input type="hidden" name="query" th:if="${selectedQuery != null}" th:value="${selectedQuery}" />
                            <div th:if="${selectedCategoryIds != null}" th:each="catId : ${selectedCategoryIds}">
                                <input type="hidden" name="categoryIds" th:value="${catId}" />
                            </div>
                            <button type="button" class="btn-icon-delete" th:attr="data-transaction-id=${transaction.id}" title="Delete">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <polyline points="3 6 5 6 21 6"></polyline>
                                    <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                                    <line x1="10" y1="11" x2="10" y2="17"></line>
                                    <line x1="14" y1="11" x2="14" y2="17"></line>
                                </svg>
                            </button>
                        </form>
                    </div>
                </div>

                <div class="card-actions" style="display: none;">
                    <a th:href="@{/transactions/edit/{id}(id=${transaction.id}, timeframe=${selectedTimeframe}, startDate=${selectedStartDate}, endDate=${selectedEndDate}, accountIds=${selectedAccountIds}, categoryIds=${selectedCategoryIds}, query=${selectedQuery})}" class="btn-edit">Edit</a>
                    <form th:action="@{/transactions/{id}/delete(id=${transaction.id})}" method="post">
                        <input type="hidden" name="timeframe" th:if="${selectedTimeframe != null}" th:value="${selectedTimeframe}" />
                        <input type="hidden" name="startDate" th:if="${selectedStartDate != null}" th:value="${selectedStartDate}" />
                        <input type="hidden" name="endDate" th:if="${selectedEndDate != null}" th:value="${selectedEndDate}" />
                        <div th:if="${selectedAccountIds != null}" th:each="accId : ${selectedAccountIds}">
                            <input type="hidden" name="accountIds" th:value="${accId}" />
                        </div>
                        <input type="hidden" name="query" th:if="${selectedQuery != null}" th:value="${selectedQuery}" />
                        <div th:if="${selectedCategoryIds != null}" th:each="catId : ${selectedCategoryIds}">
                            <input type="hidden" name="categoryIds" th:value="${catId}" />
                        </div>
                        <button type="button" class="btn-delete" th:attr="data-transaction-id=${transaction.id}">Delete</button>
                    </form>
                </div>
            </div>

            <div th:if="${transactions.empty}" style="text-align: center; padding: 2rem; background-color: white; border-radius: 0.5rem; border: 1px solid #E5E7EB;">
                No transactions match the current filter criteria.
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const timeframeSelect = document.getElementById('timeframe');
            const dateRangeFields = document.getElementById('date-range-fields');
            const categoryDisplaySelect = document.getElementById('category-display');
            const categoryListDropdown = document.getElementById('category-list-dropdown');
            const selectAllCheckbox = document.getElementById('select-all-categories');
            const clearAllCheckbox = document.getElementById('clear-all-categories');
            const categoryCheckboxes = document.querySelectorAll('.category-checkbox');
            const selectedCountSpan = document.getElementById('selected-count');
            const deleteButtons = document.querySelectorAll('.btn-delete, .btn-icon-delete');
            const modal = document.getElementById('confirmation-modal');
            const modalMessage = document.getElementById('modal-message');
            const modalConfirmBtn = document.getElementById('modal-confirm-btn');
            const modalCancelBtn = document.getElementById('modal-cancel-btn');
            const fullTextQueryInput = document.getElementById('full-text-query');
            const filterSummaryContent = document.getElementById('filter-summary-content');
            const applyFiltersBtn = document.getElementById('apply-filters-btn');
            const startDateInput = document.getElementById('start-date');
            const endDateInput = document.getElementById('end-date');
            const accountDisplaySelect = document.getElementById('account-display');
            const accountListDropdown = document.getElementById('account-list-dropdown');
            const selectAllAccountsCheckbox = document.getElementById('select-all-accounts');
            const clearAllAccountsCheckbox = document.getElementById('clear-all-accounts');
            const accountCheckboxes = document.querySelectorAll('.account-checkbox');
            const accountSelectedCountSpan = document.getElementById('account-selected-count');

            let confirmAction = null;

            // Validate Date Range and Enable/Disable Apply Button
            function validateDateRange() {
                if (timeframeSelect.value === 'date_range') {
                    const startDate = startDateInput.value;
                    const endDate = endDateInput.value;
                    
                    if (startDate && endDate) {
                        applyFiltersBtn.disabled = false;
                    } else {
                        applyFiltersBtn.disabled = true;
                    }
                } else {
                    applyFiltersBtn.disabled = false;
                }
            }

            // Timeframe and Date Range Toggle
            function toggleDateRangeFields() {
                if (timeframeSelect.value === 'date_range') {
                    dateRangeFields.classList.add('show');
                } else {
                    dateRangeFields.classList.remove('show');
                }
                validateDateRange();
                updateFilterSummary();
            }

            timeframeSelect.addEventListener('change', toggleDateRangeFields);
            startDateInput.addEventListener('change', () => {
                validateDateRange();
                updateFilterSummary();
            });
            endDateInput.addEventListener('change', () => {
                validateDateRange();
                updateFilterSummary();
            });
            toggleDateRangeFields();

            // Account Dropdown
            accountDisplaySelect.onclick = (e) => {
                accountListDropdown.style.display = accountListDropdown.style.display === 'none' ? 'block' : 'none';
                e.stopPropagation();
            };
            document.onclick = () => accountListDropdown.style.display = 'none';
            accountListDropdown.onclick = (e) => e.stopPropagation();

            // Account Selection
            function updateAccountDisplayCount() {
                const checkedCount = Array.from(accountCheckboxes).filter(cb => cb.checked).length;
                const totalCount = accountCheckboxes.length;

                let text;
                if (checkedCount === 0) {
                    text = 'None';
                } else if (checkedCount === totalCount) {
                    text = 'All';
                } else {
                    text = checkedCount;
                }
                accountSelectedCountSpan.textContent = text;
                updateFilterSummary();
            }

            selectAllAccountsCheckbox.addEventListener('change', function () {
                if (this.checked) {
                    accountCheckboxes.forEach(cb => cb.checked = true);
                    clearAllAccountsCheckbox.checked = false;
                }
                updateAccountDisplayCount();
            });

            clearAllAccountsCheckbox.addEventListener('change', function () {
                if (this.checked) {
                    accountCheckboxes.forEach(cb => cb.checked = false);
                    selectAllAccountsCheckbox.checked = false;
                }
                updateAccountDisplayCount();
            });

            accountCheckboxes.forEach(cb => {
                cb.addEventListener('change', function () {
                    selectAllAccountsCheckbox.checked = false;
                    clearAllAccountsCheckbox.checked = false;

                    const allChecked = Array.from(accountCheckboxes).every(c => c.checked);
                    const noneChecked = Array.from(accountCheckboxes).every(c => !c.checked);

                    if (allChecked) selectAllAccountsCheckbox.checked = true;
                    if (noneChecked) clearAllAccountsCheckbox.checked = true;
                    
                    updateAccountDisplayCount();
                });
            });

            // Initialize account select-all/clear-all state on page load
            const allAccountsChecked = Array.from(accountCheckboxes).every(c => c.checked);
            const noAccountsChecked = Array.from(accountCheckboxes).every(c => !c.checked);
            if (allAccountsChecked) selectAllAccountsCheckbox.checked = true;
            if (noAccountsChecked) clearAllAccountsCheckbox.checked = true;
            
            updateAccountDisplayCount();

            // Category Dropdown
            categoryDisplaySelect.onclick = (e) => {
                categoryListDropdown.style.display = categoryListDropdown.style.display === 'none' ? 'block' : 'none';
                e.stopPropagation();
            };
            document.onclick = () => categoryListDropdown.style.display = 'none';
            categoryListDropdown.onclick = (e) => e.stopPropagation();

            // Category Selection
            function updateCategoryDisplayCount() {
                const checkedCount = Array.from(categoryCheckboxes).filter(cb => cb.checked).length;
                const totalCount = categoryCheckboxes.length;

                let text;
                if (checkedCount === 0) {
                    text = 'None';
                } else if (checkedCount === totalCount) {
                    text = 'All';
                } else {
                    text = checkedCount;
                }
                selectedCountSpan.textContent = text;
                updateFilterSummary();
            }

            selectAllCheckbox.addEventListener('change', function () {
                if (this.checked) {
                    categoryCheckboxes.forEach(cb => cb.checked = true);
                    clearAllCheckbox.checked = false;
                }
                updateCategoryDisplayCount();
            });

            clearAllCheckbox.addEventListener('change', function () {
                if (this.checked) {
                    categoryCheckboxes.forEach(cb => cb.checked = false);
                    selectAllCheckbox.checked = false;
                }
                updateCategoryDisplayCount();
            });

            categoryCheckboxes.forEach(cb => {
                cb.addEventListener('change', function () {
                    selectAllCheckbox.checked = false;
                    clearAllCheckbox.checked = false;

                    const allChecked = Array.from(categoryCheckboxes).every(c => c.checked);
                    const noneChecked = Array.from(categoryCheckboxes).every(c => !c.checked);

                    if (allChecked) selectAllCheckbox.checked = true;
                    if (noneChecked) clearAllCheckbox.checked = true;
                    
                    updateCategoryDisplayCount();
                });
            });

            // Initialize category select-all/clear-all state on page load
            const allCategoriesChecked = Array.from(categoryCheckboxes).every(c => c.checked);
            const noCategoriesChecked = Array.from(categoryCheckboxes).every(c => !c.checked);
            if (allCategoriesChecked) selectAllCheckbox.checked = true;
            if (noCategoriesChecked) clearAllCheckbox.checked = true;
            
            updateCategoryDisplayCount();

            // Filter Summary
            function updateFilterSummary() {
                let summaryHTML = '';

                const selectedTimeframeText = timeframeSelect.options[timeframeSelect.selectedIndex].text;
                let timeframeValue = selectedTimeframeText;

                if (timeframeSelect.value === 'date_range') {
                    const startDate = document.getElementById('start-date').value;
                    const endDate = document.getElementById('end-date').value;

                    const formatDisplayDate = (dateString) => {
                        if (!dateString) return '';
                        try {
                            return new Date(dateString).toLocaleDateString('en-GB', {
                                year: 'numeric',
                                month: 'short',
                                day: 'numeric'
                            });
                        } catch (e) {
                            return dateString;
                        }
                    };

                    const formattedStart = formatDisplayDate(startDate);
                    const formattedEnd = formatDisplayDate(endDate);

                    if (startDate && endDate) {
                        timeframeValue = `${formattedStart} to ${formattedEnd}`;
                    } else if (startDate) {
                        timeframeValue = `From ${formattedStart}`;
                    } else if (endDate) {
                        timeframeValue = `Up to ${formattedEnd}`;
                    } else {
                        timeframeValue = selectedTimeframeText;
                    }
                }
                summaryHTML += `<div><strong>Timeframe:</strong> ${timeframeValue}</div>`;

                // Account filter
                const checkedAccounts = Array.from(accountCheckboxes)
                    .filter(cb => cb.checked)
                    .map(cb => document.querySelector(`label[for="${cb.id}"]`).textContent.trim());

                let accountsValue;
                if (checkedAccounts.length === accountCheckboxes.length) {
                    accountsValue = 'All';
                } else if (checkedAccounts.length === 0) {
                    accountsValue = 'None';
                } else if (checkedAccounts.length > 2) {
                    accountsValue = `${checkedAccounts.slice(0, 2).join(', ')}, and ${checkedAccounts.length - 2} more`;
                } else {
                    accountsValue = checkedAccounts.join(', ');
                }
                summaryHTML += `<div><strong>Accounts:</strong> ${accountsValue}</div>`;

                const checkedCategories = Array.from(categoryCheckboxes)
                    .filter(cb => cb.checked)
                    .map(cb => document.querySelector(`label[for="${cb.id}"]`).textContent.trim());

                let categoriesValue;
                if (checkedCategories.length === categoryCheckboxes.length) {
                    categoriesValue = 'All';
                } else if (checkedCategories.length === 0) {
                    categoriesValue = 'None';
                } else if (checkedCategories.length > 3) {
                    categoriesValue = `${checkedCategories.slice(0, 3).join(', ')}, and ${checkedCategories.length - 3} more`;
                } else {
                    categoriesValue = checkedCategories.join(', ');
                }
                summaryHTML += `<div><strong>Categories:</strong> ${categoriesValue}</div>`;

                const query = fullTextQueryInput.value.trim();
                if (query) {
                    summaryHTML += `<div><strong>Keywords:</strong> ${query}</div>`;
                }

                filterSummaryContent.innerHTML = summaryHTML;
            }

            fullTextQueryInput.addEventListener('input', updateFilterSummary);
            updateFilterSummary();

            // Delete Modal
            function showModal(message, callback) {
                modalMessage.textContent = message;
                confirmAction = callback;
                modal.classList.add('show');
            }

            modalConfirmBtn.onclick = () => {
                modal.classList.remove('show');
                if (confirmAction) {
                    confirmAction(true);
                }
                confirmAction = null;
            };

            modalCancelBtn.onclick = () => {
                modal.classList.remove('show');
                confirmAction = null;
            };

            deleteButtons.forEach(button => {
                button.addEventListener('click', (event) => {
                    const transactionId = button.getAttribute('data-transaction-id');
                    const form = button.closest('form');

                    showModal(
                        'Are you sure you want to delete Transaction ID: ' + transactionId + '? This action cannot be undone.',
                        (confirmed) => {
                            if (confirmed) {
                                form.submit();
                            }
                        }
                    );
                });
            });

            // Handle Filter Submission
            const filterForm = document.getElementById('filter-form');
            filterForm.addEventListener('submit', function (event) {
                if (clearAllCheckbox.checked || selectAllCheckbox.checked) {
                    categoryCheckboxes.forEach(cb => cb.disabled = true);
                }
                if (clearAllAccountsCheckbox.checked || selectAllAccountsCheckbox.checked) {
                    accountCheckboxes.forEach(cb => cb.disabled = true);
                }
            });

            window.addEventListener('load', function () {
                categoryCheckboxes.forEach(cb => cb.disabled = false);
                accountCheckboxes.forEach(cb => cb.disabled = false);
            });
        });
    </script>
</body>

</html>