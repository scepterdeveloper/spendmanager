<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">

<head>
    <title th:text="${appName} + ' - Transaction Management'">EverRich - Transaction Management</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
        /* ================================================================= 
           BASE STYLES & VARIABLES
           ================================================================= */
        :root {
            --accent-color: #047857;
            --primary-color: #1F2937;
            --text-mellow: #6B7280;
            --border-color: #E5E7EB;
        }

        * {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            color: var(--primary-color);
        }

        /* ================================================================= 
           PAGE HEADER
           ================================================================= */
        .page-header {
            display: flex;
            align-items: center;
            margin-bottom: 2rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--border-color);
        }

        .back-link {
            display: inline-flex;
            align-items: center;
            color: var(--accent-color);
            text-decoration: none;
            font-weight: 500;
            margin-right: 2rem;
            font-size: 1rem;
        }

        .back-link svg {
            margin-right: 5px;
        }

        .page-header h2 {
            color: var(--primary-color);
            margin: 0;
            font-size: 2rem;
            font-weight: 600;
        }

        /* ================================================================= 
           CONTENT WRAPPER
           ================================================================= */
        .content-wrapper {
            border: 1px solid var(--border-color);
            padding: 2rem;
            border-radius: 0.5rem;
            margin-bottom: 2rem;
            background-color: white;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
        }

        h3 {
            font-size: 0.95rem;
            margin-bottom: 1rem;
            font-weight: 500;
            color: var(--text-mellow);
        }

        /* ================================================================= 
           FORM ELEMENTS
           ================================================================= */
        label {
            display: block;
            font-weight: 500;
            margin-bottom: 0.5rem;
            font-size: 0.95rem;
        }

        select,
        input[type="date"],
        input[type="text"] {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #D1D5DB;
            border-radius: 0.25rem;
            font-size: 1rem;
        }

        /* ================================================================= 
           BUTTONS
           ================================================================= */
        .btn-filter,
        .btn-primary {
            background-color: var(--accent-color);
            color: white;
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 0.25rem;
            cursor: pointer;
            font-weight: 600;
            transition: background-color 0.3s;
            width: 100%;
        }

        .btn-filter:hover,
        .btn-primary:hover {
            background-color: #059669;
        }

        .btn-filter:disabled,
        .btn-primary:disabled {
            background-color: #9CA3AF;
            cursor: not-allowed;
            opacity: 0.6;
        }

        .btn-edit {
            background-color: #3B82F6;
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 0.25rem;
            text-decoration: none;
            font-size: 0.875rem;
            text-align: center;
            display: inline-block;
        }

        .btn-delete {
            background-color: #EF4444;
            color: white;
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 0.25rem;
            cursor: pointer;
            font-size: 0.875rem;
            transition: opacity 0.3s;
        }

        .btn-delete:hover,
        .btn-edit:hover {
            opacity: 0.9;
        }

        /* ================================================================= 
           FILTER SECTION
           ================================================================= */
        #filter-toggle {
            display: none;
        }

        .filter-toggle-label {
            display: flex;
            align-items: center;
            justify-content: space-between;
            cursor: pointer;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .toggle-icon {
            transition: transform 0.3s;
            margin-left: 10px;
        }

        #filter-toggle:checked ~ .filter-summary .toggle-icon {
            transform: rotate(180deg);
        }

        .summary-content {
            color: var(--text-mellow);
            font-size: 0.9rem;
            line-height: 1.5;
            padding-left: 10px;
        }

        .summary-content strong {
            color: var(--primary-color);
            font-weight: 500;
        }

        #filter-toggle:checked ~ .filter-summary .summary-content {
            display: none;
        }

        .filter-controls {
            display: none;
            padding-top: 15px;
            border-top: 1px solid var(--border-color);
            margin-top: 15px;
        }

        #filter-toggle:checked ~ .filter-controls {
            display: block;
        }

        /* Filter Grid - Desktop */
        .filter-grid {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 1.5rem;
            margin-bottom: 1rem;
        }

        .filter-field {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        /* Date Range Fields */
        .date-inputs {
            display: none;
            gap: 0.5rem;
        }

        .date-inputs.show {
            display: flex;
        }

        .date-inputs input {
            flex: 1;
        }

        /* Category Dropdown */
        .category-select-wrapper {
            position: relative;
        }

        .category-multi-select-dropdown {
            display: none;
            position: absolute;
            z-index: 100;
            background-color: white;
            border: 1px solid #D1D5DB;
            border-radius: 0.25rem;
            padding: 10px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            max-height: 250px;
            overflow-y: auto;
            min-width: 250px;
            margin-top: 5px;
            top: 100%;
            left: 0;
        }

        .category-multi-select-dropdown.show {
            display: block;
        }

        .category-multi-select-dropdown > div {
            padding: 3px 0;
            line-height: 1.2;
        }

        .category-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
            padding-bottom: 5px;
            border-bottom: 1px solid #EEE;
        }

        .category-header label {
            font-weight: bold;
            margin: 0;
        }

        /* ================================================================= 
           DATA TABLE
           ================================================================= */
        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
            background-color: white;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1);
            border-radius: 0.5rem;
            overflow: hidden;
            font-size: 0.95rem;
            table-layout: fixed;
        }

        .data-table th,
        .data-table td {
            padding: 1rem;
            text-align: left;
            border-bottom: 1px solid #E5E7EB;
        }

        .data-table th {
            background-color: #F3F4F6;
            font-weight: 600;
            color: var(--primary-color);
        }

        /* Column width settings for desktop */
        .data-table th:nth-child(1),
        .data-table td:nth-child(1) {
            width: 10%;
        }

        .data-table th:nth-child(2),
        .data-table td:nth-child(2) {
            width: 15%;
        }

        .data-table th:nth-child(3),
        .data-table td:nth-child(3) {
            width: 40%;
        }

        .data-table th:nth-child(4),
        .data-table td:nth-child(4) {
            width: 10%;
        }

        .data-table th:nth-child(5),
        .data-table td:nth-child(5) {
            width: 10%;
        }

        .data-table th:nth-child(6),
        .data-table td:nth-child(6) {
            width: 15%;
        }

        .action-buttons-container {
            display: flex;
            gap: 10px;
        }

        .amount-negative {
            color: #DC2626;
            font-weight: 600;
        }

        .amount-positive {
            color: #059669;
            font-weight: 600;
        }

        /* ================================================================= 
           MOBILE TRANSACTION CARDS
           ================================================================= */
        .transaction-list-mobile {
            display: none;
        }

        .transaction-card {
            background-color: white;
            border: 1px solid var(--border-color);
            border-radius: 0.5rem;
            padding: 1rem;
            margin-bottom: 1rem;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .card-date-account {
            font-size: 0.875rem;
            color: var(--text-mellow);
        }

        .card-amount {
            font-size: 1.25rem;
            font-weight: 600;
        }

        .card-description {
            font-size: 0.875rem;
            color: var(--primary-color);
            margin-bottom: 1rem;
            padding-bottom: 0.75rem;
            border-bottom: 1px solid var(--border-color);
        }

        .card-details {
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .detail-item {
            flex: 1;
        }

        .detail-item strong {
            display: block;
            font-size: 0.875rem;
            color: var(--text-mellow);
            margin-bottom: 0.25rem;
        }

        /* Mobile action buttons as icons */
        .card-actions-inline {
            display: flex;
            gap: 0.75rem;
            align-items: center;
        }

        .btn-icon-edit,
        .btn-icon-delete {
            background: none;
            border: none;
            cursor: pointer;
            padding: 0.25rem;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            transition: opacity 0.2s;
        }

        .btn-icon-edit {
            color: #3B82F6;
        }

        .btn-icon-delete {
            color: #EF4444;
        }

        .btn-icon-edit:hover,
        .btn-icon-delete:hover {
            opacity: 0.7;
        }

        /* ================================================================= 
           MODAL
           ================================================================= */
        #toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.4);
            justify-content: center;
            align-items: center;
        }

        .modal.show {
            display: flex;
        }

        .modal-content {
            background-color: white;
            padding: 20px;
            border-radius: 0.5rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            width: 90%;
            max-width: 400px;
            text-align: center;
        }

        .modal-buttons {
            margin-top: 20px;
            display: flex;
            justify-content: space-around;
            gap: 1rem;
        }

        .modal-buttons button {
            cursor: pointer;
            padding: 10px 20px;
            border-radius: 0.25rem;
            font-weight: 600;
            flex: 1;
        }

        #modal-confirm-btn {
            background-color: #EF4444;
            color: white;
            border: none;
        }

        #modal-cancel-btn {
            background-color: #D1D5DB;
            color: #1F2937;
            border: none;
        }

        /* ================================================================= 
           RESPONSIVE - MOBILE
           ================================================================= */
        @media (max-width: 767px) {
            .data-table {
                display: none;
            }

            .transaction-list-mobile {
                display: block;
            }

            .filter-grid {
                grid-template-columns: 1fr;
                gap: 1rem;
            }

            .date-inputs {
                flex-direction: column;
            }

            .page-header {
                align-items: flex-start;
                margin-bottom: 0.5rem;
                padding-bottom: 0.25rem;
                margin-left: 0;
                margin-right: 0;
            }

            .back-link {
                margin-right: 1rem;
                font-size: 0.9rem;
            }

            .page-header h2::after {
                content: "Transactions";
            }

            .page-header h2 {
                font-size: 0;
            }

            .page-header h2::after {
                font-size: 1.25rem;
            }

            /* Hide old card actions buttons on mobile, show icons instead */
            .card-actions {
                display: none !important;
            }

            .card-actions-inline {
                display: flex !important;
            }

            /* Minimize padding and margins for mobile */
            .content-wrapper {
                padding: 0.75rem;
                margin-bottom: 0.75rem;
                margin-left: 0;
                margin-right: 0;
            }

            .content-container {
                padding: 0.5rem !important;
            }

            h3 {
                margin-bottom: 0.5rem;
                margin-left: 0;
                margin-right: 0;
            }

            .transaction-card {
                padding: 0.75rem;
                margin-bottom: 0.75rem;
                margin-left: 0;
                margin-right: 0;
            }

            .card-header {
                margin-bottom: 0.375rem;
            }

            .card-description {
                margin-bottom: 0.5rem;
                padding-bottom: 0.5rem;
            }

            .filter-controls {
                padding-top: 0.75rem;
                margin-top: 0.75rem;
            }

            .filter-grid {
                gap: 0.75rem;
                margin-bottom: 0.75rem;
            }

            .filter-field {
                gap: 0.375rem;
            }

            label {
                margin-bottom: 0.375rem;
            }

            select,
            input[type="date"],
            input[type="text"] {
                padding: 0.5rem;
            }

            .btn-filter,
            .btn-primary {
                padding: 0.5rem 1rem;
            }
        }
    </style>
</head>

<body>
    <div th:replace="fragments/header :: appHeader"></div>

    <div id="toast-container"></div>
    
    <div id="confirmation-modal" class="modal">
        <div class="modal-content">
            <p id="modal-message"></p>
            <div class="modal-buttons">
                <button id="modal-confirm-btn">Yes, I'm Sure</button>
                <button id="modal-cancel-btn">Cancel</button>
            </div>
        </div>
    </div>

    <div class="content-container">
        <div class="page-header">
            <a href="/" class="back-link">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
                    stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M19 12H5"></path>
                    <path d="M12 19l-7-7 7-7"></path>
                </svg>
                Back
            </a>
            <h2>Transaction Management</h2>
        </div>

        <div class="content-wrapper">
            <form id="filter-form" action="/transactions" method="get">
                <input type="checkbox" id="filter-toggle" name="filter-toggle-state" 
                    th:checked="${selectedTimeframe != 'current_month' or selectedCategoryIds != null or selectedQuery != null}">

                <div class="filter-summary">
                    <label for="filter-toggle" class="filter-toggle-label">
                        Applied Filters
                        <svg class="toggle-icon" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" 
                             stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <polyline points="6 9 12 15 18 9"></polyline>
                        </svg>
                    </label>
                    <div class="summary-content" id="filter-summary-content"></div>
                </div>

                <div class="filter-controls">
                    <div class="filter-grid">
                        <!-- Timeframe -->
                        <div class="filter-field">
                            <label for="timeframe">Timeframe</label>
                            <select id="timeframe" name="timeframe">
                                <option value="current_month" th:selected="${selectedTimeframe == 'current_month'}">This Month</option>
                                <option value="last_month" th:selected="${selectedTimeframe == 'last_month'}">Previous Month</option>
                                <option value="current_year" th:selected="${selectedTimeframe == 'current_year'}">This Year</option>
                                <option value="previous_year" th:selected="${selectedTimeframe == 'previous_year'}">Previous Year</option>
                                <option value="entire_timeframe" th:selected="${selectedTimeframe == 'entire_timeframe'}">Entire Timeframe</option>
                                <option value="date_range" th:selected="${selectedTimeframe == 'date_range'}">Date Range</option>
                            </select>
                            <div id="date-range-fields" class="date-inputs">
                                <input type="date" id="start-date" name="startDate" placeholder="From Date"
                                    th:value="${selectedStartDate != null ? selectedStartDate : ''}" 
                                    onfocus="(this.type='date')" onblur="if(!this.value)this.type='text'">
                                <input type="date" id="end-date" name="endDate" placeholder="To Date"
                                    th:value="${selectedEndDate != null ? selectedEndDate : ''}"
                                    onfocus="(this.type='date')" onblur="if(!this.value)this.type='text'">
                            </div>
                        </div>

                        <!-- Categories -->
                        <div class="filter-field">
                            <label for="category-display">Categories</label>
                            <div class="category-select-wrapper">
                                <select id="category-display" name="category-display-toggle">
                                    <option value="" disabled selected>Filter Categories (Currently <span id="selected-count">All</span>)</option>
                                </select>
                                <div id="category-list-dropdown" class="category-multi-select-dropdown">
                                    <div class="category-header">
                                        <div>
                                            <input type="checkbox" id="select-all-categories" class="category-toggle">
                                            <label for="select-all-categories">Select All</label>
                                        </div>
                                        <div>
                                            <input type="checkbox" id="clear-all-categories" class="category-toggle">
                                            <label for="clear-all-categories">Clear All</label>
                                        </div>
                                    </div>
                                    <div th:each="category : ${categories}">
                                        <input type="checkbox" th:id="${'cat-' + category.id}" name="categoryIds"
                                            th:value="${category.id}" class="category-checkbox"
                                            th:checked="${selectedCategoryIds != null and #lists.contains(selectedCategoryIds, category.id)}">
                                        <label th:for="${'cat-' + category.id}" th:text="${category.name}">Category Name</label>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Search -->
                        <div class="filter-field">
                            <label for="full-text-query">Search (Description, Category)</label>
                            <input type="text" id="full-text-query" name="query" placeholder="Enter keywords..."
                                th:value="${selectedQuery != null ? selectedQuery : ''}" />
                        </div>
                    </div>

                    <button type="submit" id="apply-filters-btn" class="btn-filter">Apply Filters</button>
                </div>
            </form>
        </div>

        <h3 th:text="${#lists.size(transactions)} + ' transaction(s) found'">0 transaction(s) found</h3>
        
        <!-- Desktop Table -->
        <table class="data-table">
            <thead>
                <tr>
                    <th>Date</th>
                    <th>Account</th>
                    <th>Description</th>
                    <th>Amount</th>
                    <th>Category</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                <tr th:each="transaction : ${transactions}">
                    <td th:text="${#temporals.format(transaction.date, 'dd MMM yyyy')}">01 Jan 2025</td>
                    <td th:text="${transaction.account != null ? transaction.account.id + ' - ' + transaction.account.name : 'N/A'}">Account Info</td>
                    <td th:text="${transaction.description}">Netflix Subscription</td>
                    <td th:classappend="${transaction.operation != null and transaction.operation.name() == 'MINUS' ? 'amount-negative' : 'amount-positive'}">
                        <span th:text="${#numbers.formatDecimal(transaction.amount, 1, 'COMMA', 2, 'POINT')}">5.99</span> €
                    </td>
                    <td th:text="${transaction.categoryEntity?.name ?: 'Uncategorized'}">Uncategorized</td>
                    <td>
                        <div class="action-buttons-container">
                            <a th:href="@{/transactions/edit/{id}(id=${transaction.id}, timeframe=${selectedTimeframe}, startDate=${selectedStartDate}, endDate=${selectedEndDate}, categoryIds=${selectedCategoryIds}, query=${selectedQuery})}" class="btn-edit">Edit</a>
                            <form th:action="@{/transactions/{id}/delete(id=${transaction.id})}" method="post" style="display:inline;">
                                <input type="hidden" name="timeframe" th:if="${selectedTimeframe != null}" th:value="${selectedTimeframe}" />
                                <input type="hidden" name="startDate" th:if="${selectedStartDate != null}" th:value="${selectedStartDate}" />
                                <input type="hidden" name="endDate" th:if="${selectedEndDate != null}" th:value="${selectedEndDate}" />
                                <input type="hidden" name="query" th:if="${selectedQuery != null}" th:value="${selectedQuery}" />
                                <div th:if="${selectedCategoryIds != null}" th:each="catId : ${selectedCategoryIds}">
                                    <input type="hidden" name="categoryIds" th:value="${catId}" />
                                </div>
                                <button type="button" class="btn-delete" th:attr="data-transaction-id=${transaction.id}">Delete</button>
                            </form>
                        </div>
                    </td>
                </tr>
                <tr th:if="${transactions.empty}">
                    <td colspan="6" style="text-align: center; padding: 2rem;">No transactions match the current filter criteria.</td>
                </tr>
            </tbody>
        </table>

        <!-- Mobile Cards -->
        <div class="transaction-list-mobile">
            <div th:each="transaction : ${transactions}" class="transaction-card">
                <div class="card-header">
                    <div class="card-date-account">
                        <span th:text="${#temporals.format(transaction.date, 'dd MMM yyyy')}">01 Jan 2025</span> |
                        <span th:text="${transaction.account != null ? transaction.account.name : 'N/A'}">Account Name</span>
                    </div>
                    <div th:classappend="${transaction.operation != null and transaction.operation.name() == 'MINUS' ? 'amount-negative' : 'amount-positive'}" class="card-amount">
                        <span th:text="${#numbers.formatDecimal(transaction.amount, 1, 'COMMA', 2, 'POINT')}">5.99</span> €
                    </div>
                </div>
                
                <div class="card-description" th:text="${transaction.description}">Netflix Subscription</div>
                
                <div class="card-details">
                    <div class="detail-item">
                        <strong>Category</strong>
                        <span th:text="${transaction.categoryEntity?.name ?: 'Uncategorized'}">Category Name</span>
                    </div>
                    
                    <div class="card-actions-inline">
                        <a th:href="@{/transactions/edit/{id}(id=${transaction.id}, timeframe=${selectedTimeframe}, startDate=${selectedStartDate}, endDate=${selectedEndDate}, categoryIds=${selectedCategoryIds}, query=${selectedQuery})}" 
                           class="btn-icon-edit" title="Edit">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                                <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                            </svg>
                        </a>
                        <form th:action="@{/transactions/{id}/delete(id=${transaction.id})}" method="post" style="display: inline;">
                            <input type="hidden" name="timeframe" th:if="${selectedTimeframe != null}" th:value="${selectedTimeframe}" />
                            <input type="hidden" name="startDate" th:if="${selectedStartDate != null}" th:value="${selectedStartDate}" />
                            <input type="hidden" name="endDate" th:if="${selectedEndDate != null}" th:value="${selectedEndDate}" />
                            <input type="hidden" name="query" th:if="${selectedQuery != null}" th:value="${selectedQuery}" />
                            <div th:if="${selectedCategoryIds != null}" th:each="catId : ${selectedCategoryIds}">
                                <input type="hidden" name="categoryIds" th:value="${catId}" />
                            </div>
                            <button type="button" class="btn-icon-delete" th:attr="data-transaction-id=${transaction.id}" title="Delete">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <polyline points="3 6 5 6 21 6"></polyline>
                                    <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                                    <line x1="10" y1="11" x2="10" y2="17"></line>
                                    <line x1="14" y1="11" x2="14" y2="17"></line>
                                </svg>
                            </button>
                        </form>
                    </div>
                </div>

                <div class="card-actions" style="display: none;">
                    <a th:href="@{/transactions/edit/{id}(id=${transaction.id}, timeframe=${selectedTimeframe}, startDate=${selectedStartDate}, endDate=${selectedEndDate}, categoryIds=${selectedCategoryIds}, query=${selectedQuery})}" class="btn-edit">Edit</a>
                    <form th:action="@{/transactions/{id}/delete(id=${transaction.id})}" method="post">
                        <input type="hidden" name="timeframe" th:if="${selectedTimeframe != null}" th:value="${selectedTimeframe}" />
                        <input type="hidden" name="startDate" th:if="${selectedStartDate != null}" th:value="${selectedStartDate}" />
                        <input type="hidden" name="endDate" th:if="${selectedEndDate != null}" th:value="${selectedEndDate}" />
                        <input type="hidden" name="query" th:if="${selectedQuery != null}" th:value="${selectedQuery}" />
                        <div th:if="${selectedCategoryIds != null}" th:each="catId : ${selectedCategoryIds}">
                            <input type="hidden" name="categoryIds" th:value="${catId}" />
                        </div>
                        <button type="button" class="btn-delete" th:attr="data-transaction-id=${transaction.id}">Delete</button>
                    </form>
                </div>
            </div>

            <div th:if="${transactions.empty}" style="text-align: center; padding: 2rem; background-color: white; border-radius: 0.5rem; border: 1px solid #E5E7EB;">
                No transactions match the current filter criteria.
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const timeframeSelect = document.getElementById('timeframe');
            const dateRangeFields = document.getElementById('date-range-fields');
            const categoryDisplaySelect = document.getElementById('category-display');
            const categoryListDropdown = document.getElementById('category-list-dropdown');
            const selectAllCheckbox = document.getElementById('select-all-categories');
            const clearAllCheckbox = document.getElementById('clear-all-categories');
            const categoryCheckboxes = document.querySelectorAll('.category-checkbox');
            const selectedCountSpan = document.getElementById('selected-count');
            const deleteButtons = document.querySelectorAll('.btn-delete, .btn-icon-delete');
            const modal = document.getElementById('confirmation-modal');
            const modalMessage = document.getElementById('modal-message');
            const modalConfirmBtn = document.getElementById('modal-confirm-btn');
            const modalCancelBtn = document.getElementById('modal-cancel-btn');
            const fullTextQueryInput = document.getElementById('full-text-query');
            const filterSummaryContent = document.getElementById('filter-summary-content');
            const applyFiltersBtn = document.getElementById('apply-filters-btn');
            const startDateInput = document.getElementById('start-date');
            const endDateInput = document.getElementById('end-date');

            let confirmAction = null;

            // Validate Date Range and Enable/Disable Apply Button
            function validateDateRange() {
                if (timeframeSelect.value === 'date_range') {
                    const startDate = startDateInput.value;
                    const endDate = endDateInput.value;
                    
                    if (startDate && endDate) {
                        applyFiltersBtn.disabled = false;
                    } else {
                        applyFiltersBtn.disabled = true;
                    }
                } else {
                    applyFiltersBtn.disabled = false;
                }
            }

            // Timeframe and Date Range Toggle
            function toggleDateRangeFields() {
                if (timeframeSelect.value === 'date_range') {
                    dateRangeFields.classList.add('show');
                } else {
                    dateRangeFields.classList.remove('show');
                }
                validateDateRange();
                updateFilterSummary();
            }

            timeframeSelect.addEventListener('change', toggleDateRangeFields);
            startDateInput.addEventListener('change', () => {
                validateDateRange();
                updateFilterSummary();
            });
            endDateInput.addEventListener('change', () => {
                validateDateRange();
                updateFilterSummary();
            });
            toggleDateRangeFields();

            // Category Dropdown
            categoryDisplaySelect.addEventListener('mousedown', function (event) {
                event.preventDefault();
                categoryListDropdown.classList.toggle('show');
            });

            document.addEventListener('click', function (event) {
                if (!categoryListDropdown.contains(event.target) && event.target !== categoryDisplaySelect) {
                    categoryListDropdown.classList.remove('show');
                }
            });

            // Category Selection
            function updateCategoryDisplayCount() {
                const checkedCount = Array.from(categoryCheckboxes).filter(cb => cb.checked).length;
                const totalCount = categoryCheckboxes.length;

                let text;
                if (checkedCount === 0) {
                    text = 'None';
                } else if (checkedCount === totalCount) {
                    text = 'All';
                } else {
                    text = checkedCount;
                }
                selectedCountSpan.textContent = text;
                updateFilterSummary();
            }

            selectAllCheckbox.addEventListener('change', function () {
                if (this.checked) {
                    categoryCheckboxes.forEach(cb => cb.checked = true);
                    clearAllCheckbox.checked = false;
                }
                updateCategoryDisplayCount();
            });

            clearAllCheckbox.addEventListener('change', function () {
                if (this.checked) {
                    categoryCheckboxes.forEach(cb => cb.checked = false);
                    selectAllCheckbox.checked = false;
                }
                updateCategoryDisplayCount();
            });

            categoryCheckboxes.forEach(cb => {
                cb.addEventListener('change', function () {
                    selectAllCheckbox.checked = false;
                    clearAllCheckbox.checked = false;

                    const allChecked = Array.from(categoryCheckboxes).every(c => c.checked);
                    const noneChecked = Array.from(categoryCheckboxes).every(c => !c.checked);

                    if (allChecked) selectAllCheckbox.checked = true;
                    if (noneChecked) clearAllCheckbox.checked = true;
                    
                    updateCategoryDisplayCount();
                });
            });

            updateCategoryDisplayCount();

            // Filter Summary
            function updateFilterSummary() {
                let summaryHTML = '';

                const selectedTimeframeText = timeframeSelect.options[timeframeSelect.selectedIndex].text;
                let timeframeValue = selectedTimeframeText;

                if (timeframeSelect.value === 'date_range') {
                    const startDate = document.getElementById('start-date').value;
                    const endDate = document.getElementById('end-date').value;

                    const formatDisplayDate = (dateString) => {
                        if (!dateString) return '';
                        try {
                            return new Date(dateString).toLocaleDateString('en-GB', {
                                year: 'numeric',
                                month: 'short',
                                day: 'numeric'
                            });
                        } catch (e) {
                            return dateString;
                        }
                    };

                    const formattedStart = formatDisplayDate(startDate);
                    const formattedEnd = formatDisplayDate(endDate);

                    if (startDate && endDate) {
                        timeframeValue = `${formattedStart} to ${formattedEnd}`;
                    } else if (startDate) {
                        timeframeValue = `From ${formattedStart}`;
                    } else if (endDate) {
                        timeframeValue = `Up to ${formattedEnd}`;
                    } else {
                        timeframeValue = selectedTimeframeText;
                    }
                }
                summaryHTML += `<div><strong>Timeframe:</strong> ${timeframeValue}</div>`;

                const checkedCategories = Array.from(categoryCheckboxes)
                    .filter(cb => cb.checked)
                    .map(cb => document.querySelector(`label[for="${cb.id}"]`).textContent.trim());

                let categoriesValue;
                if (checkedCategories.length === categoryCheckboxes.length) {
                    categoriesValue = 'All';
                } else if (checkedCategories.length === 0) {
                    categoriesValue = 'None';
                } else if (checkedCategories.length > 3) {
                    categoriesValue = `${checkedCategories.slice(0, 3).join(', ')}, and ${checkedCategories.length - 3} more`;
                } else {
                    categoriesValue = checkedCategories.join(', ');
                }
                summaryHTML += `<div><strong>Categories:</strong> ${categoriesValue}</div>`;

                const query = fullTextQueryInput.value.trim();
                if (query) {
                    summaryHTML += `<div><strong>Keywords:</strong> ${query}</div>`;
                }

                filterSummaryContent.innerHTML = summaryHTML;
            }

            fullTextQueryInput.addEventListener('input', updateFilterSummary);
            updateFilterSummary();

            // Delete Modal
            function showModal(message, callback) {
                modalMessage.textContent = message;
                confirmAction = callback;
                modal.classList.add('show');
            }

            modalConfirmBtn.onclick = () => {
                modal.classList.remove('show');
                if (confirmAction) {
                    confirmAction(true);
                }
                confirmAction = null;
            };

            modalCancelBtn.onclick = () => {
                modal.classList.remove('show');
                confirmAction = null;
            };

            deleteButtons.forEach(button => {
                button.addEventListener('click', (event) => {
                    const transactionId = button.getAttribute('data-transaction-id');
                    const form = button.closest('form');

                    showModal(
                        'Are you sure you want to delete Transaction ID: ' + transactionId + '? This action cannot be undone.',
                        (confirmed) => {
                            if (confirmed) {
                                form.submit();
                            }
                        }
                    );
                });
            });

            // Handle Filter Submission
            const filterForm = document.getElementById('filter-form');
            filterForm.addEventListener('submit', function (event) {
                if (clearAllCheckbox.checked || selectAllCheckbox.checked) {
                    categoryCheckboxes.forEach(cb => cb.disabled = true);
                }
            });

            window.addEventListener('load', function () {
                categoryCheckboxes.forEach(cb => cb.disabled = false);
            });
        });
    </script>
</body>

</html>