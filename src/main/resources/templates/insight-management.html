<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <title th:text="${appName} + ' - Manage Insights'">EverRich - Manage Insights</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" th:href="@{/css/app-theme.css}">
    <style>
        /* Page-specific styles for Insight Management */
        
        /* Form grid layouts */
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }

        .form-row-3 {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 1rem;
        }

        /* Page-specific: Date range fields toggle - will be shown via inline style if DATE_RANGE */
        #date-range-fields {
            display: none;
        }
        
        #date-range-fields.show {
            display: grid !important;
        }

        /* Mobile responsive title override */
        @media (max-width: 767px) {
            .page-header h2 {
                font-size: 0;
            }

            .page-header h2::after {
                content: "Manage Insights";
                font-size: 1.25rem;
            }

            .form-row,
            .form-row-3 {
                grid-template-columns: 1fr;
            }

            #category-list-dropdown {
                position: fixed;
                left: 5%;
                right: 5%;
                top: 50%;
                transform: translateY(-50%);
                min-width: unset;
                max-width: 90%;
                max-height: 60vh;
            }
        }
    </style>
</head>
<body>
    <div th:replace="~{fragments/header :: appHeader}"></div>
    
    <div id="toast-container"></div>
    <div id="confirmation-modal" class="modal">
        <div class="modal-content">
            <p id="modal-message"></p>
            <div class="modal-buttons">
                <button id="modal-confirm-btn">Yes, I'm Sure</button>
                <button id="modal-cancel-btn">Cancel</button>
            </div>
        </div>
    </div>
    
    <div class="content-container-full">
        
        <div class="page-header">
            <a href="/dashboard" class="back-link">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 12H5"></path><path d="M12 19l-7-7 7-7"></path></svg>
                Back
            </a>
            <h2>Manage Saved Insights</h2>
        </div>

        <div class="collapsible-header" id="manual-header">
            <h3>
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 3v18h18"/><path d="M18 17V9"/><path d="M13 17V5"/><path d="M8 17v-4"/></svg>
                <span th:text="${newInsight.id != null ? 'Edit Insight #' + newInsight.id : 'Define a New Insight'}">Define a New Insight</span>
            </h3>
            <span class="icon">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M6 9l6 6 6-6"/></svg>
            </span>
        </div>        

        <div class="content-wrapper" id="manual-form-content">
            <form th:action="@{/insights/manage}" th:object="${newInsight}" method="post">
                
                <input type="hidden" th:field="*{id}" />
                
                <!-- Basic Info -->
                <div class="form-row">
                    <div class="form-group">
                        <label for="name">Insight Name *</label>
                        <input type="text" id="name" th:field="*{name}" placeholder="e.g., Monthly Groceries" required />
                    </div>
                    
                    <div class="form-group">
                        <label for="description">Description</label>
                        <input type="text" id="description" th:field="*{description}" placeholder="Brief description of this insight" />
                    </div>
                </div>

                <!-- Filter Parameters -->
                <div class="form-row-3">
                    <div class="form-group">
                        <label for="timeframe">Timeframe *</label>
                        <select id="timeframe" th:field="*{timeframe}" required>
                            <option value="THIS_MONTH">This Month</option>
                            <option value="LAST_MONTH">Previous Month</option>
                            <option value="THIS_YEAR">This Year</option>
                            <option value="LAST_YEAR">Previous Year</option>
                            <option value="ENTIRE_TIMEFRAME">Entire Timeframe</option>
                            <option value="DATE_RANGE">Date Range</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="intervalType">Interval</label>
                        <select id="intervalType" th:field="*{intervalType}">
                            <option value="NOT_SPECIFIED">Not Specified</option>
                            <option value="MONTHLY">Monthly</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="intervalFunction">Interval Function</label>
                        <select id="intervalFunction" th:field="*{intervalFunction}">
                            <option value="SUM">SUM</option>
                            <option value="AVG">AVG</option>
                            <option value="COUNT">COUNT</option>
                        </select>
                    </div>
                </div>

                <!-- Date Range (conditionally shown) -->
                <div class="form-row" id="date-range-fields" th:classappend="${newInsight.timeframe == 'DATE_RANGE' ? 'show' : ''}">
                    <div class="form-group">
                        <label for="startDate">Start Date</label>
                        <input type="date" id="startDate" name="startDate" th:value="${newInsight.startDate}" />
                    </div>
                    <div class="form-group">
                        <label for="endDate">End Date</label>
                        <input type="date" id="endDate" name="endDate" th:value="${newInsight.endDate}" />
                    </div>
                </div>

                <!-- Categories (dropdown like insights.html) -->
                <div class="form-group category-group">
                    <label for="category-display">Categories</label>
                    <input 
                        type="text" 
                        id="category-display" 
                        placeholder="Click to select categories" 
                        readonly 
                        style="cursor: pointer;"
                        value="Selected: "
                    />
                    <span id="selected-count" style="display: inline;">0</span>
                    <input type="hidden" id="categoryIds" th:field="*{categoryIds}" />
                    
                    <div id="category-list-dropdown" style="display: none;">
                        <div class="category-toggle-container">
                            <div>
                                <input type="checkbox" id="select-all-categories" />
                                <label for="select-all-categories">Select All</label>
                            </div>
                            <div>
                                <input type="checkbox" id="clear-all-categories" />
                                <label for="clear-all-categories">Clear All</label>
                            </div>
                        </div>
                        <div th:each="cat : ${categories}">
                            <input 
                                type="checkbox" 
                                class="category-checkbox" 
                                th:id="'cat-' + ${cat.id}" 
                                th:value="${cat.id}" 
                            />
                            <label th:for="'cat-' + ${cat.id}" th:text="${cat.name}">Category Name</label>
                        </div>
                    </div>
                </div>

                <!-- Aggregate Results and Dashboard Display -->
                <div class="form-group">
                    <div class="form-check">
                        <input type="checkbox" id="aggregateResults" th:field="*{aggregateResults}" />
                        <label for="aggregateResults">Aggregate Results</label>
                    </div>
                    <div class="form-check">
                        <input type="checkbox" id="showOnDashboard" th:field="*{showOnDashboard}" />
                        <label for="showOnDashboard">Show on Dashboard</label>
                    </div>
                </div>
                
                <div class="form-actions">
                    <button type="submit" class="btn-primary">
                        <span th:text="${newInsight.id != null ? 'Update Insight' : 'Save Insight'}">Save Insight</span>
                    </button>

                    <a th:if="${newInsight.id != null}" th:href="@{/insights/manage}" class="btn-cancel">
                        Cancel Edit
                    </a>
                </div>
            </form>
        </div>

        <h3>Existing Saved Insights</h3>
        
        <div class="data-table-wrapper">
            <table class="data-table">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Name</th>
                        <th>Description</th>
                        <th>Timeframe</th>
                        <th>Aggregate</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    <tr th:each="insight : ${savedInsights}">
                        <td th:text="${insight.id}">1</td>
                        <td>
                            <a th:href="@{/insights/manage/{id}/execute(id=${insight.id})}" 
                               style="color: var(--accent-color); text-decoration: none; font-weight: 500;"
                               th:text="${insight.name}">Monthly Groceries</a>
                        </td>
                        <td th:text="${insight.description}">Track monthly grocery spending</td>
                        <td th:text="${insight.timeframe == 'THIS_MONTH' ? 'This Month' : 
                                       insight.timeframe == 'LAST_MONTH' ? 'Previous Month' : 
                                       insight.timeframe == 'THIS_YEAR' ? 'This Year' : 
                                       insight.timeframe == 'LAST_YEAR' ? 'Previous Year' : 
                                       insight.timeframe == 'ENTIRE_TIMEFRAME' ? 'Entire Timeframe' : 
                                       insight.timeframe == 'DATE_RANGE' ? 'Date Range' : 
                                       insight.timeframe}">This Month</td>
                        <td th:text="${insight.aggregateResults ? 'Yes' : 'No'}">No</td>
                        <td>
                            <a th:href="@{/insights/manage/edit/{id}(id=${insight.id})}" class="btn-edit">
                                Edit
                            </a>
                            
                            <form th:action="@{/insights/manage/{id}/delete(id=${insight.id})}" method="post" style="display: inline;" class="delete-insight-form">
                                <button type="button" class="btn-delete" th:attr="data-insight-id=${insight.id}">Delete</button>
                            </form>
                        </td>
                    </tr>
                    <tr th:if="${savedInsights.empty}">
                        <td colspan="6">No saved insights defined yet. Please add a new one above.</td>
                    </tr>
                </tbody>
            </table>
        </div>

        <div class="mobile-list">
            <div th:each="insight : ${savedInsights}" class="mobile-card">
                <div class="mobile-card-header">
                    <div class="mobile-card-title">
                        <a th:href="@{/insights/manage/{id}/execute(id=${insight.id})}" 
                           style="color: var(--accent-color); text-decoration: none;"
                           th:text="${insight.id} + ' - ' + ${insight.name}">1 - Monthly Groceries</a>
                    </div>
                </div>
                
                <div class="mobile-card-description" th:text="${insight.description}">Track monthly grocery spending</div>

                <div style="font-size: 0.75rem; color: var(--text-mellow); margin-bottom: 0.75rem; padding-bottom: 0.75rem; border-bottom: 1px solid var(--border-color);">
                    <strong>Timeframe:</strong> <span th:text="${insight.timeframe == 'THIS_MONTH' ? 'This Month' : 
                                                                  insight.timeframe == 'LAST_MONTH' ? 'Previous Month' : 
                                                                  insight.timeframe == 'THIS_YEAR' ? 'This Year' : 
                                                                  insight.timeframe == 'LAST_YEAR' ? 'Previous Year' : 
                                                                  insight.timeframe == 'ENTIRE_TIMEFRAME' ? 'Entire Timeframe' : 
                                                                  insight.timeframe == 'DATE_RANGE' ? 'Date Range' : 
                                                                  insight.timeframe}">This Month</span> | 
                    <strong>Aggregate:</strong> <span th:text="${insight.aggregateResults ? 'Yes' : 'No'}">No</span>
                </div>

                <div class="mobile-card-actions">
                    <a th:href="@{/insights/manage/edit/{id}(id=${insight.id})}" class="action-icon edit" title="Edit">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"></path>
                        </svg>
                    </a>
                    
                    <form th:action="@{/insights/manage/{id}/delete(id=${insight.id})}" method="post" style="display: inline;" class="delete-insight-form">
                        <button type="button" class="action-icon delete delete-btn-mobile" th:attr="data-insight-id=${insight.id}" title="Delete" style="background: none; border: none; padding: 0; cursor: pointer;">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <polyline points="3 6 5 6 21 6"></polyline>
                                <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                                <line x1="10" y1="11" x2="10" y2="17"></line>
                                <line x1="14" y1="11" x2="14" y2="17"></line>
                            </svg>
                        </button>
                    </form>
                </div>
            </div>

            <div th:if="${savedInsights.empty}" style="text-align: center; padding: 2rem; background-color: white; border-radius: 0.5rem; border: 1px solid #E5E7EB;">
                No saved insights defined yet. Please add a new one above.
            </div>
        </div>
    </div>
    
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // Check if in edit mode (must be defined early)
            const isEditMode = document.querySelector('input[name="id"]').value !== "";
            
            // UI Elements
            const manualHeader = document.getElementById('manual-header'); 
            const manualContent = document.getElementById('manual-form-content'); 
            const deleteButtons = document.querySelectorAll('.btn-delete, .delete-btn-mobile');
            const modal = document.getElementById('confirmation-modal');
            const modalMessage = document.getElementById('modal-message');
            const modalConfirmBtn = document.getElementById('modal-confirm-btn');
            const modalCancelBtn = document.getElementById('modal-cancel-btn');
            const toastContainer = document.getElementById('toast-container');
            const timeframeSelect = document.getElementById('timeframe');
            const dateRangeFields = document.getElementById('date-range-fields');
            const intervalSelect = document.getElementById('intervalType');
            const intervalFunctionSelect = document.getElementById('intervalFunction');
            const categoryDisplaySelect = document.getElementById('category-display');
            const categoryListDropdown = document.getElementById('category-list-dropdown');
            const selectedCountSpan = document.getElementById('selected-count');

            let confirmAction = null;

            // Initialize category checkboxes from hidden field
            const categoryIdsField = document.getElementById('categoryIds');
            const existingCategoryIds = categoryIdsField.value ? categoryIdsField.value.split(',') : [];
            document.querySelectorAll('.category-checkbox').forEach(cb => {
                if (existingCategoryIds.includes(cb.value)) {
                    cb.checked = true;
                }
            });

            // --- Category Dropdown Toggle ---
            function toggleCategoryDropdown(event) {
                event.preventDefault();
                event.stopPropagation();
                categoryListDropdown.style.display = categoryListDropdown.style.display === 'block' ? 'none' : 'block';
            }
            
            categoryDisplaySelect.addEventListener('mousedown', toggleCategoryDropdown);
            categoryDisplaySelect.addEventListener('touchend', toggleCategoryDropdown);

            // Close dropdown when clicking outside
            document.addEventListener('click', function (event) {
                if (categoryListDropdown.style.display === 'block' &&
                    !categoryListDropdown.contains(event.target) &&
                    event.target !== categoryDisplaySelect) {
                    categoryListDropdown.style.display = 'none';
                }
            });

            // --- Category Selection Logic ---
            function updateCategoryDisplayCount() {
                const categoryCheckboxes = document.querySelectorAll('#category-list-dropdown input.category-checkbox');
                const checkedCount = Array.from(categoryCheckboxes).filter(cb => cb.checked).length;
                const totalCount = categoryCheckboxes.length;

                let text;
                if (checkedCount === 0) {
                    text = 'None';
                } else if (checkedCount === totalCount) {
                    text = 'All';
                } else {
                    text = checkedCount;
                }
                selectedCountSpan.textContent = text;
                updateCategoryIds();
            }

            // Select All / Clear All listeners
            const selectAllCheckbox = document.getElementById('select-all-categories');
            const clearAllCheckbox = document.getElementById('clear-all-categories');
            const categoryCheckboxes = document.querySelectorAll('#category-list-dropdown input.category-checkbox');

            selectAllCheckbox.addEventListener('change', function () {
                categoryCheckboxes.forEach(cb => cb.checked = this.checked);
                clearAllCheckbox.checked = false;
                updateCategoryDisplayCount();
            });

            clearAllCheckbox.addEventListener('change', function () {
                categoryCheckboxes.forEach(cb => cb.checked = !this.checked);
                selectAllCheckbox.checked = false;
                updateCategoryDisplayCount();
            });

            categoryCheckboxes.forEach(cb => {
                cb.addEventListener('change', function () {
                    selectAllCheckbox.checked = false;
                    clearAllCheckbox.checked = false;
                    const allChecked = Array.from(categoryCheckboxes).every(c => c.checked);
                    const noneChecked = Array.from(categoryCheckboxes).every(c => !c.checked);
                    selectAllCheckbox.checked = allChecked;
                    clearAllCheckbox.checked = noneChecked;
                    updateCategoryDisplayCount();
                });
            });

            // Initialize category display count
            updateCategoryDisplayCount();

            // --- Interval Function Logic ---
            function toggleIntervalFunction() {
                const selectedInterval = intervalSelect.value;
                intervalFunctionSelect.disabled = (selectedInterval === 'NOT_SPECIFIED');
            }
            intervalSelect.addEventListener('change', toggleIntervalFunction);

            // --- Timeframe Logic ---
            function toggleDateRangeAndInterval() {
                const selectedTimeframe = timeframeSelect.value;

                if (selectedTimeframe === 'DATE_RANGE') {
                    dateRangeFields.style.display = 'grid';
                } else {
                    dateRangeFields.style.display = 'none';
                }

                const enableInterval = ['THIS_YEAR', 'LAST_YEAR', 'DATE_RANGE', 'ENTIRE_TIMEFRAME'].includes(selectedTimeframe);
                intervalSelect.disabled = !enableInterval;
                if (!enableInterval) {
                    intervalSelect.value = 'NOT_SPECIFIED';
                }
                toggleIntervalFunction();
            }
            timeframeSelect.addEventListener('change', toggleDateRangeAndInterval);
            
            // Initialize on load - ensure date range fields are shown if DATE_RANGE is selected
            toggleDateRangeAndInterval();
            
            // Force display of date range fields if in edit mode with DATE_RANGE
            if (isEditMode && timeframeSelect.value === 'DATE_RANGE') {
                dateRangeFields.style.display = 'grid';
            }

            // --- Notification and Modal Helpers ---
            function showToast(message, type = 'success') {
                const toast = document.createElement('div');
                toast.className = `toast ${type}`;
                toast.textContent = message;
                toastContainer.appendChild(toast);

                setTimeout(() => {
                    toast.classList.add('show');
                }, 10);

                setTimeout(() => {
                    toast.classList.remove('show');
                    toast.addEventListener('transitionend', () => toast.remove());
                }, 5000);
            }

            function showModal(message, callback) {
                modalMessage.textContent = message;
                confirmAction = callback;
                modal.style.display = 'flex';
            }

            modalConfirmBtn.onclick = () => {
                modal.style.display = 'none';
                if (confirmAction) {
                    confirmAction(true);
                }
            };

            modalCancelBtn.onclick = () => {
                modal.style.display = 'none';
                if (confirmAction) {
                    confirmAction(false);
                }
                confirmAction = null;
            };

            // --- Insight Deletion Logic ---
            deleteButtons.forEach(button => {
                button.addEventListener('click', (event) => {
                    event.preventDefault();
                    event.stopPropagation();
                    
                    const form = button.closest('form');
                    
                    showModal(
                        'Are you sure you want to delete this saved insight? This cannot be undone!', 
                        (confirmed) => {
                            if (confirmed) {
                                form.submit();
                            } else {
                                showToast('Deletion cancelled.', 'error');
                            }
                        }
                    );
                });
            });

            // --- Section Collapse Logic ---
            if (!isEditMode) {
                 manualContent.style.display = 'none';
                 manualHeader.classList.add('collapsed');
            } else {
                 manualHeader.classList.remove('collapsed');
            }
           
            function toggleSection(header, content) {
                 const isCollapsed = content.style.display === 'none';
                 content.style.display = isCollapsed ? 'block' : 'none';
                 header.classList.toggle('collapsed');
            }
            
            manualHeader.addEventListener('click', () => {
                 if (!isEditMode) {
                    toggleSection(manualHeader, manualContent);
                 } else {
                    showToast("Please use 'Cancel Edit' to hide the form.", 'error');
                 }
            });
        });

        // Category selection helpers
        function updateCategoryIds() {
            const checkboxes = document.querySelectorAll('.category-checkbox:checked');
            const ids = Array.from(checkboxes).map(cb => cb.value);
            document.getElementById('categoryIds').value = ids.join(',');
        }
    </script>
</body>
</html>