<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">

<head>
    <title th:text="${appName} + ' - Dashboard'">EverRich - Dashboard</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" th:href="@{/css/app-theme.css}">

    <style>
        /* Dashboard-specific styles */

        /* --- KPI Pulse Section --- */
        .pulse-group {
            margin-bottom: 1rem;
        }

        .pulse-header {
            margin: 0 0 0.5rem 0.1rem;
            display: flex;
            align-items: center;
            gap: 0.4rem;
        }

        .pulse-header h2 {
            font-size: 0.7rem;
            font-weight: 800;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text-mellow);
            margin: 0;
        }

        .pulse-dot {
            width: 7px;
            height: 7px;
            background-color: var(--accent-color);
            border-radius: 50%;
            box-shadow: 0 0 6px var(--accent-color);
            animation: pulse-glow 2s infinite;
        }

        @keyframes pulse-glow {
            0% { opacity: 0.4; }
            50% { opacity: 1; }
            100% { opacity: 0.4; }
        }

        /* --- KPI Cards --- */
        .kpi-container {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            width: 100%;
            scroll-behavior: smooth;
        }

        .kpi-card {
            background: white;
            border-radius: 0.4rem;
            padding: 0.75rem 0.25rem;
            border: 1px solid var(--border-color);
            position: relative;
            text-align: center;
            flex: 0 0 auto;
            width: calc(33.33% - 0.4rem);
            min-width: 100px;
            max-width: 160px;
            box-sizing: border-box;
        }

        .kpi-card::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            border-radius: 0.4rem 0.4rem 0 0;
            background: var(--income-color);
        }

        .kpi-title {
            font-size: 0.55rem;
            color: var(--text-mellow);
            font-weight: 700;
            text-transform: uppercase;
            margin-bottom: 0.1rem;
        }

        .kpi-value {
            font-size: 1.1rem;
            font-weight: 800;
            color: var(--primary-color);
        }

        /* --- Charts Carousel --- */
        .charts-carousel-wrapper {
            position: relative;
            display: flex;
            align-items: center;
            width: 100%;
            margin-bottom: 1.25rem;
        }

        .charts-container {
            display: flex;
            overflow-x: hidden;
            scroll-behavior: smooth;
            gap: 1rem;
            width: 100%;
            scrollbar-width: none;
        }

        .charts-container::-webkit-scrollbar {
            display: none;
        }

        .chart-slide {
            flex: 0 0 100%;
            min-width: 100%;
            scroll-snap-align: start;
        }

        .chart-card {
            background: white;
            border-radius: 0.4rem;
            padding: 0.75rem;
            border: 1px solid var(--border-color);
        }

        .chart-title {
            font-size: 0.8rem;
            font-weight: 700;
            margin: 0 0 0.75rem 0;
            color: var(--primary-color);
            display: flex;
            align-items: center;
            gap: 0.3rem;
        }

        .chart-container {
            height: 180px;
            width: 100%;
        }

        /* --- Mobile Overrides --- */
        @media (max-width: 767px) {
            .nav-btn {
                display: flex;
            }

            .kpi-container {
                flex-wrap: nowrap;
                overflow-x: auto;
                gap: 0.4rem;
                scrollbar-width: none;
            }

            .kpi-container::-webkit-scrollbar {
                display: none;
            }

            .kpi-card {
                width: 120px;
                min-width: 120px;
                padding: 0.6rem 0.15rem;
            }

            .kpi-value {
                font-size: 0.95rem;
            }

            .sleek-link:hover {
                transform: none;
            }

            .action-groups-container {
                grid-template-columns: repeat(2, 1fr);
                gap: 0.75rem;
            }

            .group-name {
                font-size: 0.65rem;
            }

            .link-label {
                font-size: 0.8rem;
            }

            .link-subtext {
                font-size: 0.6rem;
            }

            .link-icon-wrapper {
                width: 26px;
                height: 26px;
                margin-right: 0.5rem;
            }

            .link-icon-wrapper svg {
                width: 12px;
                height: 12px;
            }

            .sleek-link {
                padding: 0.4rem 0.3rem;
                margin-left: -0.3rem;
            }
        }
    </style>
</head>

<body>
    <div th:replace="~{fragments/header :: appHeader}"></div>

    <div id="category-data" th:attr="data-category-count=${categoryCount}"></div>

    <div class="content-container-full">

        <!-- Financial Pulse KPI Section -->
        <div class="pulse-group">
            <div class="pulse-header">
                <div class="pulse-dot"></div>
                <h2>Financial Pulse</h2>
            </div>
            
            <div class="carousel-wrapper">
                <button id="btnPrev" class="nav-btn nav-prev nav-hidden" onclick="scrollKPIs(-1)">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                        <polyline points="15 18 9 12 15 6"></polyline>
                    </svg>
                </button>

                <div class="kpi-container" id="kpiContainer">
                    <div th:each="kpi : ${dashBoardKPIs}" class="kpi-card">
                        <div class="kpi-title" th:text="${kpi.insightName}">Insight Name</div>
                        <div class="kpi-value"
                            th:text="${kpi.aggregatedValue != null ? #numbers.formatDecimal(kpi.aggregatedValue, 1, 'POINT', 2, 'COMMA') + ' €' : '0,00 €'}">
                            0,00 €
                        </div>
                    </div>
                </div>

                <button id="btnNext" class="nav-btn nav-next" onclick="scrollKPIs(1)">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                        <polyline points="9 18 15 12 9 6"></polyline>
                    </svg>
                </button>
            </div>
        </div>

        <!-- Dynamic Charts Carousel Section -->
        <div class="charts-carousel-wrapper">
            <button id="btnChartPrev" class="nav-btn nav-prev nav-hidden" onclick="scrollCharts(-1)">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                    <polyline points="15 18 9 12 15 6"></polyline>
                </svg>
            </button>

            <div class="charts-container" id="chartsContainer">
                <div th:each="chart, iterStat : ${dashBoardCharts}" 
                     th:if="${chart.resultType.name() == 'CHART'}"
                     class="chart-card chart-slide">
                    <h3 class="chart-title">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" style="color: var(--accent-color)">
                            <path d="M3 3v18h18" />
                            <path d="M18 17V9" />
                            <path d="M13 17V5" />
                            <path d="M8 17v-4" />
                        </svg>
                        <span th:text="${chart.insightName}">Chart Title</span>
                    </h3>
                    <div class="chart-container">
                        <canvas th:id="'chart-' + ${iterStat.index}"></canvas>
                    </div>
                </div>
            </div>

            <button id="btnChartNext" class="nav-btn nav-next" onclick="scrollCharts(1)">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                    <polyline points="9 18 15 12 9 6"></polyline>
                </svg>
            </button>
        </div>

        <!-- Hidden data elements for JavaScript access -->
        <div id="chart-data" style="display: none;">
            <div th:each="chart, iterStat : ${dashBoardCharts}"
                 th:if="${chart.resultType.name() == 'CHART'}"
                 th:attr="data-chart-index=${iterStat.index},
                          data-chart-name=${chart.insightName}"
                 class="chart-data-item">
                <span th:each="dp : ${chart.dataPoints}" 
                      th:attr="data-label=${dp.label}, data-value=${dp.value}"
                      class="data-point"></span>
            </div>
        </div>

        <!-- Action Groups Section -->
        <div class="action-groups-container">
            <div class="action-group">
                <div class="group-header">
                    <h3 class="group-name">Transactions</h3>
                </div>
                <div class="links-list">
                    <a th:href="@{/transactions/add}" class="sleek-link">
                        <div class="link-icon-wrapper">
                            <svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="3" viewBox="0 0 24 24">
                                <line x1="12" y1="5" x2="12" y2="19" />
                                <line x1="5" y1="12" x2="19" y2="12" />
                            </svg>
                        </div>
                        <div class="link-text-content">
                            <span class="link-label">Create</span>
                            <span class="link-subtext">Create transactions manually</span>
                        </div>
                    </a>
                    <a th:href="@{/statements}" class="sleek-link">
                        <div class="link-icon-wrapper">
                            <svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2.5" viewBox="0 0 24 24">
                                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" />
                                <polyline points="17 8 12 3 7 8" />
                                <line x1="12" y1="3" x2="12" y2="15" />
                            </svg>
                        </div>
                        <div class="link-text-content">
                            <span class="link-label">Upload</span>
                            <span class="link-subtext">Upload transactions via statements</span>
                        </div>
                    </a>
                    <a th:href="@{/transactions}" class="sleek-link">
                        <div class="link-icon-wrapper">
                            <svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2.5" viewBox="0 0 24 24">
                                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" />
                                <polyline points="17 8 12 3 7 8" />
                                <line x1="12" y1="3" x2="12" y2="15" />
                            </svg>
                        </div>
                        <div class="link-text-content">
                            <span class="link-label">Review</span>
                            <span class="link-subtext">View/Edit Transactions</span>
                        </div>
                    </a>
                </div>
            </div>

            <div class="action-group">
                <div class="group-header">
                    <h3 class="group-name">Insights</h3>
                </div>
                <div class="links-list">
                    <a th:href="@{/insights}" class="sleek-link">
                        <div class="link-icon-wrapper">
                            <svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2.5" viewBox="0 0 24 24">
                                <path d="M3 3v18h18" />
                                <path d="M18 17V9" />
                                <path d="M13 17V5" />
                                <path d="M8 17v-4" />
                            </svg>
                        </div>
                        <div class="link-text-content">
                            <span class="link-label">Quick Analysis</span>
                            <span class="link-subtext">Draw quick insights</span>
                        </div>
                    </a>
                    <a th:href="@{/insights/manage}" class="sleek-link">
                        <div class="link-icon-wrapper">
                            <svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2.5" viewBox="0 0 24 24">
                                <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7" />
                                <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z" />
                            </svg>
                        </div>
                        <div class="link-text-content">
                            <span class="link-label">Manage Insights</span>
                            <span class="link-subtext">Define/maintain insights</span>
                        </div>
                    </a>
                </div>
            </div>

            <div class="action-group">
                <div class="group-header">
                    <h3 class="group-name">Configuration</h3>
                </div>
                <div class="links-list">
                    <a th:href="@{/categories}" class="sleek-link">
                        <div class="link-icon-wrapper">
                            <svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2.5" viewBox="0 0 24 24">
                                <path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5" />
                            </svg>
                        </div>
                        <div class="link-text-content">
                            <span class="link-label">Categories</span>
                            <span class="link-subtext">Manage categories</span>
                        </div>
                    </a>
                    <a th:href="@{/accounts}" class="sleek-link">
                        <div class="link-icon-wrapper">
                            <svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2.5" viewBox="0 0 24 24">
                                <rect x="3" y="11" width="18" height="11" rx="2" ry="2" />
                                <path d="M7 11V7a5 5 0 0 1 10 0v4" />
                            </svg>
                        </div>
                        <div class="link-text-content">
                            <span class="link-label">Accounts</span>
                            <span class="link-subtext">Manage Accounts</span>
                        </div>
                    </a>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script>
        // KPI Carousel Logic
        const container = document.getElementById('kpiContainer');
        const btnPrev = document.getElementById('btnPrev');
        const btnNext = document.getElementById('btnNext');

        function updateArrows() {
            if (container.scrollLeft <= 5) {
                btnPrev.classList.add('nav-hidden');
            } else {
                btnPrev.classList.remove('nav-hidden');
            }

            if (container.scrollLeft + container.offsetWidth >= container.scrollWidth - 5) {
                btnNext.classList.add('nav-hidden');
            } else {
                btnNext.classList.remove('nav-hidden');
            }
        }

        function scrollKPIs(direction) {
            container.scrollBy({ left: direction * 130, behavior: 'smooth' });
        }

        container.addEventListener('scroll', updateArrows);
        window.addEventListener('load', updateArrows);
        window.addEventListener('resize', updateArrows);

        // Charts Carousel & Rendering Logic
        document.addEventListener('DOMContentLoaded', function () {
            const chartsContainer = document.getElementById('chartsContainer');
            const btnChartPrev = document.getElementById('btnChartPrev');
            const btnChartNext = document.getElementById('btnChartNext');
            
            // Update chart carousel arrows
            function updateChartArrows() {
                if (!chartsContainer || !btnChartPrev || !btnChartNext) return;
                
                if (chartsContainer.scrollLeft <= 5) {
                    btnChartPrev.classList.add('nav-hidden');
                } else {
                    btnChartPrev.classList.remove('nav-hidden');
                }

                if (chartsContainer.scrollLeft + chartsContainer.offsetWidth >= chartsContainer.scrollWidth - 5) {
                    btnChartNext.classList.add('nav-hidden');
                } else {
                    btnChartNext.classList.remove('nav-hidden');
                }
            }
            
            // Scroll charts carousel
            window.scrollCharts = function(direction) {
                if (!chartsContainer) return;
                const slideWidth = chartsContainer.offsetWidth;
                chartsContainer.scrollBy({ left: direction * slideWidth, behavior: 'smooth' });
            };
            
            if (chartsContainer) {
                chartsContainer.addEventListener('scroll', updateChartArrows);
                updateChartArrows();
            }
            
            // Parse chart data from hidden elements and render charts
            const chartDataContainer = document.getElementById('chart-data');
            if (!chartDataContainer) return;
            
            const chartDataItems = chartDataContainer.querySelectorAll('.chart-data-item');
            
            chartDataItems.forEach((item) => {
                const chartIndex = item.getAttribute('data-chart-index');
                const chartName = item.getAttribute('data-chart-name');
                
                const dataPointElements = item.querySelectorAll('.data-point');
                const labels = [];
                const values = [];
                
                dataPointElements.forEach((dp) => {
                    labels.push(dp.getAttribute('data-label'));
                    values.push(parseFloat(dp.getAttribute('data-value')));
                });
                
                // Create chart
                const canvas = document.getElementById('chart-' + chartIndex);
                if (canvas) {
                    const ctx = canvas.getContext('2d');
                    new Chart(ctx, {
                        type: 'bar',
                        data: {
                            labels: labels,
                            datasets: [{
                                data: values,
                                backgroundColor: '#10b981',
                                borderRadius: 2
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: { display: false }
                            },
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    grid: { color: '#f3f4f6' },
                                    ticks: { font: { size: 9 } }
                                },
                                x: {
                                    grid: { display: false },
                                    ticks: { font: { size: 9 } }
                                }
                            }
                        }
                    });
                }
            });
        });
    </script>
</body>
</html>