<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">

<head>
    <title th:text="${appName} + ' - Insights'">EverRich - Insights</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" th:href="@{/css/app-theme.css}">
    <style>
        /* --- Page-Specific: Filter Grid --- */
        .filter-container {
            display: grid;
            grid-template-columns: 1fr;
            gap: 15px;
        }

        @media (min-width: 768px) {
            .filter-container {
                grid-template-columns: repeat(4, 1fr);
                gap: 12px 15px;
            }
        }

        /* --- Date Range Fields --- */
        #date-range-fields {
            display: none;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        #date-range-fields.show {
            display: grid;
        }

        /* --- Mobile Responsive: Page-Specific --- */
        @media (max-width: 767px) {
            .filter-container {
                grid-template-columns: 1fr;
            }

            #date-range-fields {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>

<body>
    <div th:replace="~{fragments/header :: appHeader}"></div>

    <div id="toast-container"></div>
    <div class="content-container-full">

        <div class="page-header">
            <a href="/dashboard" class="back-link">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 12H5"></path><path d="M12 19l-7-7 7-7"></path></svg>
                Back
            </a>
            <h2>Spending Insights & Analysis</h2>
        </div>

        <div class="content-wrapper">
            <form id="filter-form" th:action="@{/insights/execute}" method="post">
                <div class="filter-container">
                    <div class="form-group">
                        <label for="timeframe">Timeframe</label>
                        <select id="timeframe" name="timeframe">
                            <option value="THIS_MONTH">This Month</option>
                            <option value="LAST_MONTH">Previous Month</option>
                            <option value="THIS_YEAR">This Year</option>
                            <option value="LAST_YEAR">Previous Year</option>
                            <option value="ENTIRE_TIMEFRAME">Entire Timeframe</option>
                            <option value="DATE_RANGE">Date Range</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="interval">Interval</label>
                        <select id="interval" name="interval" disabled onchange="toggleIntervalFunction()">
                            <option value="NOT_SPECIFIED">Not Specified</option>
                            <option value="MONTHLY">Monthly</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="intervalFunction">Function</label>
                        <select id="intervalFunction" name="intervalFunction" disabled>
                            <option value="SUM">SUM</option>
                        </select>
                    </div>

                    <div class="form-group category-group">
                        <label for="category-display">Categories</label>
                        <div style="display: flex; align-items: center;">
                            <input type="text" id="category-display" placeholder="Select categories" readonly style="cursor: pointer; flex: 1;" value="Selected: " />
                            <span id="selected-count" style="margin-left: -35px; font-size: 0.85rem; color: var(--accent-color); font-weight: bold; z-index: 5;">All</span>
                        </div>
                        <input type="hidden" id="categoryIds" name="categoryIds" />
                        
                        <div id="category-list-dropdown" style="display:none;">
                            <div class="category-toggle-container">
                                <div>
                                    <input type="checkbox" id="select-all-categories" checked>
                                    <label for="select-all-categories">Select All</label>
                                </div>
                                <div>
                                    <input type="checkbox" id="clear-all-categories">
                                    <label for="clear-all-categories">Clear All</label>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div id="date-range-fields" style="grid-column: 1 / -1;">
                        <div class="form-group">
                            <label for="startDate">Start Date</label>
                            <input type="date" id="startDate" name="startDate">
                        </div>
                        <div class="form-group">
                            <label for="endDate">End Date</label>
                            <input type="date" id="endDate" name="endDate">
                        </div>
                    </div>

                    <div style="grid-column: 1 / -1; margin-top: 5px;">
                        <div class="form-check">
                            <input type="checkbox" id="aggregateResults" name="aggregateResults" class="form-check-input">
                            <label for="aggregateResults">Aggregate Total Only</label>
                        </div>
                    </div>

                    <div style="grid-column: 1 / -1;">
                        <button type="submit" class="btn-primary">Analyze</button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <script th:inline="javascript">
        /*<![CDATA[*/
        document.addEventListener('DOMContentLoaded', function() {
            const timeframeSelect = document.getElementById('timeframe');
            const intervalSelect = document.getElementById('interval');
            const intervalFn = document.getElementById('intervalFunction');
            const categoryDisplay = document.getElementById('category-display');
            const categoryDropdown = document.getElementById('category-list-dropdown');
            const selectedCountSpan = document.getElementById('selected-count');

            // Timeframe change handler
            timeframeSelect.addEventListener('change', function() {
                const dateRangeFields = document.getElementById('date-range-fields');
                if (this.value === 'DATE_RANGE') {
                    dateRangeFields.classList.add('show');
                } else {
                    dateRangeFields.classList.remove('show');
                }
                const supportsInterval = ['THIS_YEAR', 'LAST_YEAR', 'DATE_RANGE', 'ENTIRE_TIMEFRAME'].includes(this.value);
                intervalSelect.disabled = !supportsInterval;
                if (!supportsInterval) {
                    intervalSelect.value = 'NOT_SPECIFIED';
                    intervalFn.disabled = true;
                }
            });

            window.toggleIntervalFunction = () => {
                intervalFn.disabled = (intervalSelect.value === 'NOT_SPECIFIED');
            };

            // Category dropdown handlers
            categoryDisplay.onclick = (e) => {
                categoryDropdown.style.display = categoryDropdown.style.display === 'none' ? 'block' : 'none';
                e.stopPropagation();
            };
            document.onclick = () => categoryDropdown.style.display = 'none';
            categoryDropdown.onclick = (e) => e.stopPropagation();

            function updateCategoryUI() {
                const checkboxes = document.querySelectorAll('.cat-cb');
                const checked = Array.from(checkboxes).filter(cb => cb.checked);
                if (checked.length === 0) selectedCountSpan.textContent = "None";
                else if (checked.length === checkboxes.length) selectedCountSpan.textContent = "All";
                else selectedCountSpan.textContent = checked.length;
                
                // Update hidden field with comma-separated IDs
                const ids = Array.from(checked).map(cb => cb.value);
                document.getElementById('categoryIds').value = ids.join(',');
            }

            document.getElementById('select-all-categories').onclick = function() {
                document.querySelectorAll('.cat-cb').forEach(cb => cb.checked = this.checked);
                document.getElementById('clear-all-categories').checked = false;
                updateCategoryUI();
            };

            document.getElementById('clear-all-categories').onclick = function() {
                document.querySelectorAll('.cat-cb').forEach(cb => cb.checked = !this.checked);
                document.getElementById('select-all-categories').checked = false;
                updateCategoryUI();
            };

            // Load categories
            async function loadCategories() {
                const res = await fetch('/api/insights/categories');
                const cats = await res.json();
                const container = document.getElementById('category-list-dropdown');
                cats.forEach(c => {
                    const d = document.createElement('div');
                    d.innerHTML = `<input type="checkbox" value="${c.id}" id="cat-${c.id}" class="cat-cb" checked> <label for="cat-${c.id}">${c.name}</label>`;
                    container.appendChild(d);
                    d.querySelector('input').onchange = updateCategoryUI;
                });
                updateCategoryUI();
            }
            loadCategories();
        });
        /*]]>*/
    </script>
</body>
</html>